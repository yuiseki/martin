<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Martin Tile Server Documentation</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="quick-start.html"><strong aria-hidden="true">1.</strong> Quick Start</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="quick-start-linux.html"><strong aria-hidden="true">1.1.</strong> On Linux</a></li><li class="chapter-item expanded "><a href="quick-start-macos.html"><strong aria-hidden="true">1.2.</strong> On macOS</a></li><li class="chapter-item expanded "><a href="quick-start-windows.html"><strong aria-hidden="true">1.3.</strong> On Windows</a></li><li class="chapter-item expanded "><a href="quick-start-qgis.html"><strong aria-hidden="true">1.4.</strong> View with QGIS</a></li></ol></li><li class="chapter-item expanded "><a href="installation.html"><strong aria-hidden="true">2.</strong> Installation</a></li><li class="chapter-item expanded "><a href="run.html"><strong aria-hidden="true">3.</strong> Running</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="run-with-cli.html"><strong aria-hidden="true">3.1.</strong> Command Line Interface</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="env-vars.html"><strong aria-hidden="true">3.1.1.</strong> Environment Variables</a></li></ol></li><li class="chapter-item expanded "><a href="run-with-docker.html"><strong aria-hidden="true">3.2.</strong> Running with Docker</a></li><li class="chapter-item expanded "><a href="run-with-docker-compose.html"><strong aria-hidden="true">3.3.</strong> Running with Docker Compose</a></li><li class="chapter-item expanded "><a href="run-with-nginx.html"><strong aria-hidden="true">3.4.</strong> Running with NGINX</a></li><li class="chapter-item expanded "><a href="run-with-apache.html"><strong aria-hidden="true">3.5.</strong> Running with Apache</a></li><li class="chapter-item expanded "><a href="run-with-lambda.html"><strong aria-hidden="true">3.6.</strong> Running in AWS Lambda</a></li><li class="chapter-item expanded "><a href="troubleshooting.html"><strong aria-hidden="true">3.7.</strong> Troubleshooting</a></li></ol></li><li class="chapter-item expanded "><a href="config-file.html"><strong aria-hidden="true">4.</strong> Configuration File</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="pg-connections.html"><strong aria-hidden="true">4.1.</strong> PostgreSQL Connections</a></li><li class="chapter-item expanded "><a href="sources-pg-tables.html"><strong aria-hidden="true">4.2.</strong> PostgreSQL Table Sources</a></li><li class="chapter-item expanded "><a href="sources-pg-functions.html"><strong aria-hidden="true">4.3.</strong> PostgreSQL Function Sources</a></li><li class="chapter-item expanded "><a href="sources-files.html"><strong aria-hidden="true">4.4.</strong> MBTiles and PMTiles File Sources</a></li><li class="chapter-item expanded "><a href="sources-composite.html"><strong aria-hidden="true">4.5.</strong> Composite Sources</a></li><li class="chapter-item expanded "><a href="sources-sprites.html"><strong aria-hidden="true">4.6.</strong> Sprite Sources</a></li><li class="chapter-item expanded "><a href="sources-fonts.html"><strong aria-hidden="true">4.7.</strong> Font Sources</a></li></ol></li><li class="chapter-item expanded "><a href="using.html"><strong aria-hidden="true">5.</strong> Usage and Endpoint API</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="using-with-maplibre.html"><strong aria-hidden="true">5.1.</strong> Using with MapLibre</a></li><li class="chapter-item expanded "><a href="using-with-leaflet.html"><strong aria-hidden="true">5.2.</strong> Using with Leaflet</a></li><li class="chapter-item expanded "><a href="using-with-deck-gl.html"><strong aria-hidden="true">5.3.</strong> Using with deck.gl</a></li><li class="chapter-item expanded "><a href="using-with-mapbox.html"><strong aria-hidden="true">5.4.</strong> Using with Mapbox</a></li><li class="chapter-item expanded "><a href="using-with-openlayers.html"><strong aria-hidden="true">5.5.</strong> Using with OpenLayers</a></li><li class="chapter-item expanded "><a href="recipes.html"><strong aria-hidden="true">5.6.</strong> Recipes</a></li></ol></li><li class="chapter-item expanded "><a href="tools.html"><strong aria-hidden="true">6.</strong> Tools</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="martin-cp.html"><strong aria-hidden="true">6.1.</strong> martin-cp bulk tile generation</a></li><li class="chapter-item expanded "><a href="mbtiles-meta.html"><strong aria-hidden="true">6.2.</strong> MBTiles Metadata</a></li><li class="chapter-item expanded "><a href="mbtiles-schema.html"><strong aria-hidden="true">6.3.</strong> MBTiles Schemas</a></li><li class="chapter-item expanded "><a href="mbtiles-copy.html"><strong aria-hidden="true">6.4.</strong> Copying MBTiles</a></li><li class="chapter-item expanded "><a href="mbtiles-diff.html"><strong aria-hidden="true">6.5.</strong> Diffing/Patching MBTiles</a></li><li class="chapter-item expanded "><a href="mbtiles-validation.html"><strong aria-hidden="true">6.6.</strong> Validating MBTiles</a></li></ol></li><li class="chapter-item expanded "><a href="development.html"><strong aria-hidden="true">7.</strong> Development</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="getting-involved.html"><strong aria-hidden="true">7.1.</strong> Getting involved</a></li><li class="chapter-item expanded "><a href="martin-as-a-library.html"><strong aria-hidden="true">7.2.</strong> Martin as a library</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Martin Tile Server Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/maplibre/martin" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p><img src="https://raw.githubusercontent.com/maplibre/martin/main/logo.png" alt="Martin" /></p>
<p>Martin is a tile server able to generate and serve <a href="https://github.com/mapbox/vector-tile-spec">vector tiles</a> on the fly from large <a href="https://github.com/postgis/postgis">PostGIS</a> databases, <a href="https://protomaps.com/blog/pmtiles-v3-whats-new">PMTiles</a> (local or remote), and <a href="https://github.com/mapbox/mbtiles-spec">MBTiles</a> files, allowing multiple tile sources to be dynamically combined into one. Martin optimizes for speed and heavy traffic, and is written in <a href="https://github.com/rust-lang/rust">Rust</a>.</p>
<p>See also <a href="https://martin.maplibre.org/">Martin demo site</a></p>
<hr />
<p><a href="https://maplibre.org/martin"><img src="https://img.shields.io/badge/docs-Book-informational" alt="Book" /></a>
<a href="https://docs.rs/martin"><img src="https://docs.rs/martin/badge.svg" alt="docs.rs docs" /></a>
<a href="https://slack.openstreetmap.us/"><img src="https://img.shields.io/badge/Slack-%23maplibre--martin-blueviolet?logo=slack" alt="" /></a>
<a href="https://github.com/maplibre/martin"><img src="https://img.shields.io/badge/github-maplibre/martin-8da0cb?logo=github" alt="GitHub" /></a>
<a href="https://crates.io/crates/martin"><img src="https://img.shields.io/crates/v/martin.svg" alt="crates.io version" /></a>
<a href="https://github.com/maplibre/martin/security"><img src="https://github.com/maplibre/martin/workflows/Security%20audit/badge.svg" alt="Security audit" /></a>
<a href="https://github.com/maplibre/martin/actions"><img src="https://github.com/maplibre/martin/actions/workflows/ci.yml/badge.svg" alt="CI build" /></a></p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="martin-quick-start-guide"><a class="header" href="#martin-quick-start-guide">Martin Quick Start Guide</a></h2>
<p>Choose your operating system to get started with Martin tile server</p>
<ul>
<li><a href="quick-start-linux.html">Linux</a></li>
<li><a href="quick-start-macos.html">macOS</a></li>
<li><a href="quick-start-windows.html">Windows</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="quick-start-on-linux"><a class="header" href="#quick-start-on-linux">Quick start on Linux</a></h2>
<pre><code class="language-bash">mkdir martin
cd martin

# Download some sample data
curl -L -O https://github.com/maplibre/martin/raw/main/tests/fixtures/mbtiles/world_cities.mbtiles

# Download the latest version of Martin binary, extract it, and make it executable
curl -L -O https://github.com/maplibre/martin/releases/latest/download/martin-x86_64-unknown-linux-gnu.tar.gz
tar -xzf martin-x86_64-unknown-linux-gnu.tar.gz
chmod +x ./martin

# Show Martin help screen
./martin --help

# Run Martin with the sample data as the only tile source
./martin world_cities.mbtiles
</code></pre>
<h3 id="view-the-map"><a class="header" href="#view-the-map">View the map</a></h3>
<p>See <a href="quick-start-qgis.html">quick start with QGIS</a> for instructions on how to view the map.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="quick-start-on-macos"><a class="header" href="#quick-start-on-macos">Quick start on macOS</a></h2>
<ol>
<li>
<p>Download some <a href="https://github.com/maplibre/martin/raw/main/tests/fixtures/mbtiles/world_cities.mbtiles">demo tiles</a>.</p>
</li>
<li>
<p>Download the latest version of Martin from
the <a href="https://github.com/maplibre/martin/releases/latest">release page</a>.
Use <a href="https://support.apple.com/en-us/116943">about this Mac</a> to find your processors type.</p>
<ul>
<li>Use <a href="https://github.com/maplibre/martin/releases/latest/download/martin-x86_64-apple-darwin.tar.gz">martin-x86_64-apple-darwin.tar.gz</a> for Intel</li>
<li>Use <a href="https://github.com/maplibre/martin/releases/latest/download/martin-aarch64-apple-darwin.tar.gz">martin-aarch64-apple-darwin.tar.gz</a> for M1</li>
</ul>
</li>
<li>
<p>Extract content of both files and place them in a same directory.</p>
</li>
<li>
<p>Open the command prompt and navigate to the directory where <code>martin</code> and <code>world_cities.mbtiles</code> are located.</p>
</li>
<li>
<p>Run the following command to start Martin with the demo data:</p>
</li>
</ol>
<pre><code class="language-bash"># Show Martin help screen
./martin --help

# Run Martin with the sample data as the only tile source
./martin world_cities.mbtiles
</code></pre>
<h3 id="view-the-map-1"><a class="header" href="#view-the-map-1">View the map</a></h3>
<p>See <a href="quick-start-qgis.html">quick start with QGIS</a> for instructions on how to view the map.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="quick-start-on-windows"><a class="header" href="#quick-start-on-windows">Quick start on Windows</a></h2>
<ol>
<li>
<p>Download some <a href="https://github.com/maplibre/martin/raw/main/tests/fixtures/mbtiles/world_cities.mbtiles">demo tiles</a>.</p>
</li>
<li>
<p>Download the latest Windows version of Martin from
the <a href="https://github.com/maplibre/martin/releases">release page</a>:  <a href="https://github.com/maplibre/martin/releases/latest/download/martin-x86_64-pc-windows-msvc.zip">martin-x86_64-pc-windows-msvc.zip</a></p>
</li>
<li>
<p>Extract content of both files and place them in a same directory.</p>
</li>
<li>
<p>Open the command prompt and navigate to the directory where <code>martin</code> and <code>world_cities.mbtiles</code> are located.</p>
</li>
<li>
<p>Run the following command to start Martin with the demo data:</p>
</li>
</ol>
<pre><code class="language-bash"># Show Martin help screen
martin --help

# Run Martin with the sample data as the only tile source
martin world_cities.mbtiles
</code></pre>
<h3 id="view-the-map-2"><a class="header" href="#view-the-map-2">View the map</a></h3>
<p>See <a href="quick-start-qgis.html">quick start with QGIS</a> for instructions on how to view the map.</p>
<div style="break-before: page; page-break-before: always;"></div><h3 id="view-map-with-qgis"><a class="header" href="#view-map-with-qgis">View map with QGIS</a></h3>
<ol>
<li>
<p>Download, install, and run <a href="https://qgis.org/en/site/forusers/download.html">QGIS</a> for your platform</p>
</li>
<li>
<p>Add a new <code>Vector Tiles</code> connection</p>
<blockquote>
<p><img src="images/qgis_add_vector_tile.png" alt="alt text" /></p>
</blockquote>
</li>
<li>
<p>In the <code>Vector Tile Connection</code> dialog, give it some name and the URL of the Martin server,
e.g.  <code>http://localhost:3000/world_cities/{z}/{x}/{y}</code> and click <code>OK</code>.</p>
<blockquote>
<p><img src="images/qgis_add_vector_tile_options.png" alt="alt text" /></p>
</blockquote>
</li>
<li>
<p>In the QGIS browser panel (left), double-click the newly added connection, or right-click it and click
on <code>Add Layer to Project</code>.</p>
<blockquote>
<p><img src="images/qgis_add_to_layers.png" alt="alt text" /></p>
</blockquote>
</li>
<li>
<p>The map should now be visible in the QGIS map view.</p>
<blockquote>
<p><img src="images/qgis_shows_in_the_map.png" alt="alt text" /></p>
</blockquote>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h3 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h3>
<p>If using Martin with PostgreSQL database, you must install PostGIS with at least v3.0+. Postgis v3.1+ is recommended.</p>
<h3 id="docker"><a class="header" href="#docker">Docker</a></h3>
<p>Martin is also available as a <a href="https://ghcr.io/maplibre/martin">Docker image</a>. You could either share a configuration
file from the host with the container via the <code>-v</code> param, or you can let Martin auto-discover all sources e.g. by
passing <code>DATABASE_URL</code> or specifying the .mbtiles/.pmtiles files or URLs to .pmtiles.</p>
<pre><code class="language-bash">export PGPASSWORD=postgres  # secret!

docker run -p 3000:3000 \
           -e PGPASSWORD \
           -e DATABASE_URL=postgresql://user@host:port/db \
           -v /path/to/config/dir:/config \
           ghcr.io/maplibre/martin --config /config/config.yaml
</code></pre>
<h3 id="from-binary-distributions-manually"><a class="header" href="#from-binary-distributions-manually">From Binary Distributions Manually</a></h3>
<p>You can download martin from <a href="https://github.com/maplibre/martin/releases">GitHub releases page</a>.</p>
<div class="table-wrapper"><table><thead><tr><th>Platform</th><th>x64</th><th>ARM-64</th></tr></thead><tbody>
<tr><td>Linux</td><td><a href="https://github.com/maplibre/martin/releases/latest/download/martin-x86_64-unknown-linux-gnu.tar.gz">.tar.gz</a> (gnu)<br><a href="https://github.com/maplibre/martin/releases/latest/download/martin-x86_64-unknown-linux-musl.tar.gz">.tar.gz</a> (musl)<br><a href="https://github.com/maplibre/martin/releases/latest/download/martin-Debian-x86_64.deb">.deb</a></td><td><a href="https://github.com/maplibre/martin/releases/latest/download/martin-aarch64-unknown-linux-musl.tar.gz">.tar.gz</a> (musl)</td></tr>
<tr><td>macOS</td><td><a href="https://github.com/maplibre/martin/releases/latest/download/martin-x86_64-apple-darwin.tar.gz">.tar.gz</a></td><td><a href="https://github.com/maplibre/martin/releases/latest/download/martin-aarch64-apple-darwin.tar.gz">.tar.gz</a></td></tr>
<tr><td>Windows</td><td><a href="https://github.com/maplibre/martin/releases/latest/download/martin-x86_64-pc-windows-msvc.zip">.zip</a></td><td></td></tr>
</tbody></table>
</div>
<p>Rust users can install pre-built martin binary
with <a href="https://github.com/cargo-bins/cargo-binstall">cargo-binstall</a> and <code>cargo</code>.</p>
<pre><code class="language-bash">cargo install cargo-binstall
cargo binstall martin
martin --help
</code></pre>
<h3 id="from-package"><a class="header" href="#from-package">From package</a></h3>
<p>To install with apt source and others, We need your help
to <a href="https://github.com/maplibre/martin/issues/578">improve packaging for various platforms</a>.</p>
<h4 id="homebrew"><a class="header" href="#homebrew">Homebrew</a></h4>
<p>If you are using macOS and <a href="https://brew.sh/">Homebrew</a> you can install martin using Homebrew tap.</p>
<pre><code class="language-bash">brew tap maplibre/martin
brew install martin
martin --help
</code></pre>
<h4 id="debian-packagesx86_64-manually"><a class="header" href="#debian-packagesx86_64-manually">Debian Packages(x86_64) manually</a></h4>
<pre><code class="language-bash">curl -O https://github.com/maplibre/martin/releases/latest/download/martin-Debian-x86_64.deb
sudo dpkg -i ./martin-Debian-x86_64.deb
martin --help
rm ./martin-Debian-x86_64.deb
</code></pre>
<h3 id="building-from-source"><a class="header" href="#building-from-source">Building From source</a></h3>
<p>If you <a href="https://www.rust-lang.org/tools/install">install Rust</a>, you can build martin from source with Cargo:</p>
<pre><code class="language-bash">cargo install martin --locked
martin --help
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="usage"><a class="header" href="#usage">Usage</a></h1>
<p>Martin requires at least one PostgreSQL <a href="pg-connections.html">connection string</a> or a <a href="sources-files.html">tile source file</a>
as a command-line argument. A PG connection string can also be passed via the <code>DATABASE_URL</code> environment variable.</p>
<pre><code class="language-bash">martin postgresql://postgres@localhost/db
</code></pre>
<p>Martin provides <a href="https://github.com/mapbox/tilejson-spec">TileJSON</a> endpoint for
each <a href="https://postgis.net/docs/using_postgis_dbmanagement.html#geometry_columns">geospatial-enabled</a> table in your
database.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="command-line-interface"><a class="header" href="#command-line-interface">Command-line Interface</a></h2>
<p>You can configure Martin using command-line interface.
See <code>martin --help</code> or <code>cargo run -- --help</code> for more information:</p>
<pre><code class="language-text">Blazing fast and lightweight tile server with PostGIS, MBTiles, and PMTiles support

Usage: martin [OPTIONS] [CONNECTION]...

Arguments:
  [CONNECTION]...
          Connection strings, e.g. postgres://... or /path/to/files

Options:
  -c, --config &lt;CONFIG&gt;
          Path to config file. If set, no tile source-related parameters are allowed

      --save-config &lt;SAVE_CONFIG&gt;
          Save resulting config to a file or use "-" to print to stdout.
          By default, only print if sources are auto-detected

  -C, --cache-size &lt;CACHE_SIZE&gt;
          Main cache size (in MB)

  -s, --sprite &lt;SPRITE&gt;
          Export a directory with SVG files as a sprite source. Can be specified multiple times

  -f, --font &lt;FONT&gt;
          Export a font file or a directory with font files as a font source (recursive). Can be specified multiple times

  -k, --keep-alive &lt;KEEP_ALIVE&gt;
          Connection keep alive timeout. [DEFAULT: 75]

  -l, --listen-addresses &lt;LISTEN_ADDRESSES&gt;
          The socket address to bind. [DEFAULT: 0.0.0.0:3000]

      --base-path &lt;BASE_PATH&gt;
          Set TileJSON URL path prefix.

          This overrides the default of respecting the X-Rewrite-URL header.
          Only modifies the JSON (TileJSON) returned, martins' API-URLs remain unchanged.
          If you need to rewrite URLs, please use a reverse proxy.
          Must begin with a /.

          Examples: /, /tiles

  -W, --workers &lt;WORKERS&gt;
          Number of web server workers

      --preferred-encoding &lt;PREFERRED_ENCODING&gt;
          Martin server preferred tile encoding. [DEFAULT: gzip]

          If the client accepts multiple compression formats, and the tile source is not pre-compressed, which compression should be used. gzip is faster, but brotli is smaller, and may be faster with caching.

          [possible values: brotli, gzip]

  -u, --webui &lt;WEB_UI&gt;
          Control Martin web UI. [DEFAULT: disabled]

          Possible values:
          - disable:        Disable Web UI interface. This is the default, but once implemented, the default will be enabled for localhost.
          - enable-for-all: Enable Web UI interface on all connections

  -b, --auto-bounds &lt;AUTO_BOUNDS&gt;
          Specify how bounds should be computed for the spatial PG tables. [DEFAULT: quick]

          Possible values:
          - quick: Compute table geometry bounds, but abort if it takes longer than 5 seconds
          - calc:  Compute table geometry bounds. The startup time may be significant. Make sure all GEO columns have indexes
          - skip:  Skip bounds calculation. The bounds will be set to the whole world

      --ca-root-file &lt;CA_ROOT_FILE&gt;
          Loads trusted root certificates from a file. The file should contain a sequence of PEM-formatted CA certificates

  -d, --default-srid &lt;DEFAULT_SRID&gt;
          If a spatial PG table has SRID 0, then this default SRID will be used as a fallback

  -p, --pool-size &lt;POOL_SIZE&gt;
          Maximum Postgres connections pool size [DEFAULT: 20]

  -m, --max-feature-count &lt;MAX_FEATURE_COUNT&gt;
          Limit the number of features in a tile from a PG table source

  -h, --help
          Print help (see a summary with '-h')

  -V, --version
          Print version

Use RUST_LOG environment variable to control logging level, e.g. RUST_LOG=debug or RUST_LOG=martin=debug. See https://docs.rs/env_logger/latest/env_logger/index.html#enabling-logging for more information.
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="environment-variables"><a class="header" href="#environment-variables">Environment Variables</a></h2>
<p>You can also configure Martin using environment variables, but only if the configuration file is not used. See <a href="config-file.html">configuration section</a> on how to use environment variables with config files. See also <a href="pg-connections.html#postgresql-ssl-connections">SSL configuration</a> section below.</p>
<div class="table-wrapper"><table><thead><tr><th>Environment var <br/> Config File key</th><th>Example</th><th>Description</th></tr></thead><tbody>
<tr><td><code>DATABASE_URL</code> <br/> <code>connection_string</code></td><td><code>postgresql://postgres@localhost/db</code></td><td>Postgres database connection</td></tr>
<tr><td><code>DEFAULT_SRID</code> <br/> <code>default_srid</code></td><td><code>4326</code></td><td>If a PostgreSQL table has a geometry column with SRID=0, use this value instead</td></tr>
<tr><td><code>PGSSLCERT</code> <br/> <code>ssl_cert</code></td><td><code>./postgresql.crt</code></td><td>A file with a client SSL certificate. <a href="https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-CONNECT-SSLCERT">docs</a></td></tr>
<tr><td><code>PGSSLKEY</code> <br/> <code>ssl_key</code></td><td><code>./postgresql.key</code></td><td>A file with the key for the client SSL certificate. <a href="https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-CONNECT-SSLKEY">docs</a></td></tr>
<tr><td><code>PGSSLROOTCERT</code> <br/> <code>ssl_root_cert</code></td><td><code>./root.crt</code></td><td>A file with trusted root certificate(s). The file should contain a sequence of PEM-formatted CA certificates. <a href="https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-CONNECT-SSLROOTCERT">docs</a></td></tr>
<tr><td><code>AWS_LAMBDA_RUNTIME_API</code></td><td></td><td>If defined, connect to AWS Lambda to handle requests. The regular HTTP server is not used. See <a href="run-with-lambda.html">Running in AWS Lambda</a></td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h2 id="running-with-docker"><a class="header" href="#running-with-docker">Running with Docker</a></h2>
<p>You can use official Docker image <a href="https://ghcr.io/maplibre/martin"><code>ghcr.io/maplibre/martin</code></a></p>
<h3 id="using-non-local-postgresql"><a class="header" href="#using-non-local-postgresql">Using Non-Local PostgreSQL</a></h3>
<pre><code class="language-bash">docker run \
  -p 3000:3000 \
  -e DATABASE_URL=postgresql://postgres@postgres.example.org/db \
  ghcr.io/maplibre/martin
</code></pre>
<h3 id="exposing-local-files"><a class="header" href="#exposing-local-files">Exposing Local Files</a></h3>
<p>You can expose local files to the Docker container using the <code>-v</code> flag.</p>
<pre><code class="language-bash">docker run \
  -p 3000:3000 \
  -v /path/to/local/files:/files \
  ghcr.io/maplibre/martin /files
</code></pre>
<h3 id="accessing-local-postgresql-on-linux"><a class="header" href="#accessing-local-postgresql-on-linux">Accessing Local PostgreSQL on Linux</a></h3>
<p>If you are running PostgreSQL instance on <code>localhost</code>, you have to change network settings to allow the Docker container
to access the <code>localhost</code> network.</p>
<p>For Linux, add the <code>--net=host</code> flag to access the <code>localhost</code> PostgreSQL service. You would not need to export ports
with <code>-p</code> because the container is already using the host network.</p>
<pre><code class="language-bash">docker run \
  --net=host \
  -e DATABASE_URL=postgresql://postgres@localhost/db \
  ghcr.io/maplibre/martin
</code></pre>
<h3 id="accessing-local-postgresql-on-macos"><a class="header" href="#accessing-local-postgresql-on-macos">Accessing Local PostgreSQL on macOS</a></h3>
<p>For macOS, use <code>host.docker.internal</code> as hostname to access the <code>localhost</code> PostgreSQL service.</p>
<pre><code class="language-bash">docker run \
  -p 3000:3000 \
  -e DATABASE_URL=postgresql://postgres@host.docker.internal/db \
  ghcr.io/maplibre/martin
</code></pre>
<h3 id="accessing-local-postgresql-on-windows"><a class="header" href="#accessing-local-postgresql-on-windows">Accessing Local PostgreSQL on Windows</a></h3>
<p>For Windows, use <code>docker.for.win.localhost</code> as hostname to access the <code>localhost</code> PostgreSQL service.</p>
<pre><code class="language-bash">docker run \
  -p 3000:3000 \
  -e DATABASE_URL=postgresql://postgres@docker.for.win.localhost/db \
  ghcr.io/maplibre/martin
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="running-with-docker-compose"><a class="header" href="#running-with-docker-compose">Running with Docker Compose</a></h2>
<p>You can use example <a href="https://raw.githubusercontent.com/maplibre/martin/main/docker-compose.yml"><code>docker-compose.yml</code></a>
file as a reference</p>
<pre><code class="language-yml">services:
  martin:
    image: ghcr.io/maplibre/martin:v0.13.0
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgresql://postgres:password@db/db
    depends_on:
      - db

  db:
    image: postgis/postgis:16-3.4-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_DB=db
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      # persist PostgreSQL data in a local directory outside of the docker container
      - ./pg_data:/var/lib/postgresql/data
</code></pre>
<p>First, you need to start <code>db</code> service</p>
<pre><code class="language-bash">docker compose up -d db
</code></pre>
<p>Then, after <code>db</code> service is ready to accept connections, you can start <code>martin</code></p>
<pre><code class="language-bash">docker compose up -d martin
</code></pre>
<p>By default, Martin will be available at <a href="http://localhost:3000/">localhost:3000</a></p>
<p>Official Docker image includes a <code>HEALTHCHECK</code> instruction which will be used by Docker Compose. Note that Compose won’t restart unhealthy containers. To monitor and restart unhealthy containers you can use <a href="https://github.com/willfarrell/docker-autoheal">Docker Autoheal</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="using-with-nginx"><a class="header" href="#using-with-nginx">Using with NGINX</a></h2>
<p>You can run Martin behind NGINX proxy, so you can cache frequently accessed tiles and reduce unnecessary pressure on the database. Here is an example <code>docker-compose.yml</code> file that runs Martin with NGINX and PostgreSQL.</p>
<pre><code class="language-yml">version: '3'

services:
  nginx:
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./cache:/var/cache/nginx
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - martin

  martin:
    image: maplibre/martin:v0.7.0
    restart: unless-stopped
    environment:
      - DATABASE_URL=postgresql://postgres:password@db/db
    depends_on:
      - db

  db:
    image: postgis/postgis:14-3.3-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_DB=db
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - ./pg_data:/var/lib/postgresql/data
</code></pre>
<p>You can find an example NGINX configuration file <a href="https://github.com/maplibre/martin/blob/main/demo/frontend/nginx.conf">here</a>.</p>
<h3 id="rewriting-urls"><a class="header" href="#rewriting-urls">Rewriting URLs</a></h3>
<p>If you are running Martin behind NGINX proxy, you may want to rewrite the request URL to properly handle tile URLs in <a href="using.html#source-tilejson">TileJSON</a>.</p>
<pre><code class="language-nginx">location ~ /tiles/(?&lt;fwd_path&gt;.*) {
    proxy_set_header  X-Rewrite-URL $uri;
    proxy_set_header  X-Forwarded-Host $host:$server_port;
    proxy_set_header  X-Forwarded-Proto $scheme;
    proxy_redirect    off;

    proxy_pass        http://martin:3000/$fwd_path$is_args$args;
}
</code></pre>
<h3 id="caching-tiles"><a class="header" href="#caching-tiles">Caching tiles</a></h3>
<p>You can also use NGINX to cache tiles. In the example, the maximum cache size is set to 10GB, and caching time is set to 1 hour for responses with codes 200, 204, and 302 and 1 minute for responses with code 404.</p>
<pre><code class="language-nginx">http {
  ...
  proxy_cache_path  /var/cache/nginx/
                    levels=1:2
                    max_size=10g
                    use_temp_path=off
                    keys_zone=tiles_cache:10m;

  server {
    ...
    location ~ /tiles/(?&lt;fwd_path&gt;.*) {
        proxy_set_header        X-Rewrite-URL $uri;
        proxy_set_header        X-Forwarded-Host $host:$server_port;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_redirect          off;

        proxy_cache             tiles_cache;
        proxy_cache_lock        on;
        proxy_cache_revalidate  on;

        # Set caching time for responses
        proxy_cache_valid       200 204 302 1h;
        proxy_cache_valid       404 1m;

        proxy_cache_use_stale   error timeout http_500 http_502 http_503 http_504;
        add_header              X-Cache-Status $upstream_cache_status;

        proxy_pass              http://martin:3000/$fwd_path$is_args$args;
    }
  }
}
</code></pre>
<p>You can find an example NGINX configuration file <a href="https://github.com/maplibre/martin/blob/main/demo/frontend/nginx.conf">here</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="using-with-apache"><a class="header" href="#using-with-apache">Using with Apache</a></h2>
<p>You can run Martin behind Apache “kind of” proxy, so you can use HTTPs with it. Here is an example of the configuration file that runs Martin with Apache.</p>
<p>First you have to setup a virtual host that is working on the port 443.</p>
<h3 id="enable-necessary-modules"><a class="header" href="#enable-necessary-modules">Enable necessary modules</a></h3>
<p>Ensure the required modules are enabled:</p>
<pre><code class="language-bash">
sudo a2enmod proxy
sudo a2enmod proxy_http
sudo a2enmod headers
sudo a2enmod rewrite

</code></pre>
<h3 id="modify-your-vhost-configuration"><a class="header" href="#modify-your-vhost-configuration">Modify your VHOST configuration</a></h3>
<p>Open your VHOST configuration file for the domaine you’re using, mydomain.tld :</p>
<pre><code class="language-bash">
sudo nano /etc/apache2/sites-available/mydomain.tld.conf

</code></pre>
<h3 id="update-the-configuration"><a class="header" href="#update-the-configuration">Update the configuration</a></h3>
<pre><code class="language-apache">
&lt;VirtualHost *:443&gt;
    ServerName mydomain.tld
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/mydomain
    ProxyPreserveHost On

    RewriteEngine on
    RewriteCond %{REQUEST_URI} ^/tiles/(.*)$
    RewriteRule ^/tiles/(.*)$ http://localhost:3000/tiles/$1 [P,L]

    &lt;IfModule mod_headers.c&gt;
        RequestHeader set X-Forwarded-Proto "https"
    &lt;/IfModule&gt;

    ProxyPass / http://localhost:3000/
    ProxyPassReverse / http://localhost:3000/
&lt;/VirtualHost&gt;

</code></pre>
<h3 id="check-configuration--verify-the-apache-configuration-for-syntax-errors"><a class="header" href="#check-configuration--verify-the-apache-configuration-for-syntax-errors">Check Configuration:  Verify the Apache configuration for syntax errors</a></h3>
<pre><code class="language-bash">
sudo apache2ctl configtest

</code></pre>
<h3 id="restart-apache-if-the-configuration-is-correct-restart-apache-to-apply-the-changes"><a class="header" href="#restart-apache-if-the-configuration-is-correct-restart-apache-to-apply-the-changes">Restart Apache: If the configuration is correct, restart Apache to apply the changes</a></h3>
<pre><code class="language-bash">
sudo systemctl restart apache2

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="using-with-aws-lambda---v014"><a class="header" href="#using-with-aws-lambda---v014">Using with AWS Lambda - v0.14+</a></h2>
<p>Martin can run in AWS Lambda. This is useful if you want to serve tiles from a serverless environment, while accessing “nearby” data from a PostgreSQL database or PMTiles file in S3, without exposing the raw file to the world to prevent download abuse and improve performance.</p>
<p>Lambda has two deployment models: zip file and container-based. When using zip file deployment, there is an online code editor to edit the yaml configuration. When using container-based deployment, we can pass our configuration on the command line or environment variables.</p>
<p>Everything can be performed via AWS CloudShell, or you can install the AWS CLI and the AWS SAM CLI, and configure authentication. The CloudShell also runs in a particular AWS region.</p>
<h3 id="container-deployment"><a class="header" href="#container-deployment">Container deployment</a></h3>
<p>Lambda images must come from a public or private ECR registry. Pull the image from GHCR and push it to ECR.</p>
<pre><code class="language-bash">$ docker pull ghcr.io/maplibre/martin:latest --platform linux/arm64
$ aws ecr create-repository --repository-name martin
[…]
        "repositoryUri": "493749042871.dkr.ecr.us-east-2.amazonaws.com/martin",

# Read the repositoryUri which includes your account number
$ docker tag ghcr.io/maplibre/martin:latest 493749042871.dkr.ecr.us-east-2.amazonaws.com/martin:latest
$ aws ecr get-login-password --region us-east-2 | docker login --username AWS --password-stdin 493749042871.dkr.ecr.us-east-2.amazonaws.com
$ docker push 493749042871.dkr.ecr.us-east-2.amazonaws.com/martin:latest
</code></pre>
<p>Open <a href="https://console.aws.amazon.com/lambda">Lambda console</a> and create your function:</p>
<ol>
<li>Click “Create function”.</li>
<li>Choose “Container image”.</li>
<li>Put something in “Function name”.
<ul>
<li><strong>Note</strong>: This is an internal identifier, not exposed in the function URL.</li>
</ul>
</li>
<li>Click “Browse images”, and select your repository and the tag.
<ul>
<li>If you cannot find it, see if you are in the same region?</li>
</ul>
</li>
<li>Expand “Container image overrides”, and under CMD put the URL of a <code>.pmtiles</code> file.</li>
<li>Set “Architecture” to <code>arm64</code> to match the platform that we pulled. Lambda has better ARM CPUs than x86.</li>
<li>Click “Create function”.</li>
<li>Find the “Configuration” tab, select “Function URL”, “Create function URL”.</li>
<li>Set “Auth type” to <code>NONE</code>
<ul>
<li>Do not enable <code>CORS</code>. Martin already has <code>CORS</code> support, so it will create incorrect duplicate headers.</li>
</ul>
</li>
<li>Click on the “Function URL”.</li>
<li>To debug an issue, open the “Monitor” tab, “View CloudWatch logs”, find the most recent Log stream.</li>
</ol>
<h3 id="zip-deployment"><a class="header" href="#zip-deployment">Zip deployment</a></h3>
<p>It’s possible to deploy the entire codebase from the AWS console, but we will use Serverless Application Model. Our function will consist of a “Layer”, containing the Martin binary, and our function itself will contain the configuration in yaml format.</p>
<h4 id="the-layer"><a class="header" href="#the-layer">The layer</a></h4>
<p>Download the binary and place it in your staging directory. The <code>bin</code> directory of your Layer will be added to the PATH.</p>
<pre><code class="language-bash">mkdir -p martin_layer/src/bin/
cd martin_layer
curl -OL https://github.com/maplibre/martin/releases/latest/download/martin-aarch64-unknown-linux-musl.tar.gz
tar -C src/bin/ -xzf martin-aarch64-unknown-linux-musl.tar.gz martin
</code></pre>
<p>Every zip-based Lambda function runs a file called <code>bootstrap</code>.</p>
<pre><code class="language-bash">cat &lt;&lt;EOF &gt;src/bootstrap
#!/bin/sh
set -eu
exec martin --config \${_HANDLER}.yaml
EOF
</code></pre>
<p>Write the SAM template.</p>
<pre><code class="language-yaml">cat &lt;&lt;EOF &gt;template.yaml
AWSTemplateFormatVersion: 2010-09-09
Transform: 'AWS::Serverless-2016-10-31'
Resources:
  martin:
    Type: 'AWS::Serverless::LayerVersion'
    DeletionPolicy: Delete
    Properties:
      ContentUri: src
      CompatibleRuntimes:
      - provided.al2023
      CompatibleArchitectures:
      - arm64
Outputs:
  LayerArn:
    Value: !Ref MartinLayer
    Export:
      Name: !Sub "${AWS::StackName}-LayerArn"
EOF
</code></pre>
<p>Run <code>sam deploy --guided</code>.</p>
<ol>
<li>Stack Name: Name your CloudFormation stack something like <code>martin-layer</code>.</li>
<li>Press enter for everything else</li>
<li>The settings are saved to <code>samconfig.toml</code>, so you can later do <code>sam deploy</code> to update the version, or <code>sam delete</code>.</li>
</ol>
<p>Now if you visit the <a href="https://console.aws.amazon.com/lambda/home">Lambda console</a> and select “Layers”, you should see your layer.</p>
<h4 id="the-function"><a class="header" href="#the-function">The function</a></h4>
<ol>
<li>Select “Functions”, “Create function”.</li>
<li>Put something in “Function name”.</li>
<li>Set “Runtime” to “Amazon Linux 2023”.</li>
<li>Set “Architecture” to “arm64”.</li>
<li>Under “Advanced settings”, choose “Enable function URL” with “Auth type” of “NONE”.</li>
<li>Click “Create function”.</li>
</ol>
<p>Add your layer:</p>
<ol>
<li>Click “add a layer” (green banner at the top, or the very bottom).</li>
<li>Choose “Custom layers”, and select your layer and its version.</li>
<li>Click “Add”.</li>
</ol>
<p>Add your configuration file in the function source code:</p>
<ol>
<li>
<p>Code tab, File, New File: <code>hello.handler.yaml</code>.</p>
<pre><code class="language-yaml">pmtiles:
  sources:
    demotiles: &lt;url to a pmtiles file&gt;
</code></pre>
</li>
<li>
<p>Click Deploy, wait for the success banner, and visit your function URL.</p>
</li>
</ol>
<h3 id="todo"><a class="header" href="#todo">TODO</a></h3>
<p>AWS Lambda support is preliminary; there are features to add to Martin, configuration to tweak, and documentation to improve.  Your help is welcome.</p>
<ul>
<li>Lambda has a default timeout of 3 seconds, and 128 MB of memory, maybe this is suboptimal.</li>
<li>Document how to connect to a PostgreSQL database on RDS.</li>
<li>Set up a CloudFront CDN, this is a whole thing, but explain the motivation and the basics.</li>
<li>Grant the execution role permission to read objects from an S3 bucket, and teach Martin how to make authenticated requests to S3.</li>
<li>Teach Martin how to serve all PMTiles files from an S3 bucket rather than having to list them at startup.</li>
<li>Teach Martin how to set the Cache-Control and Etag headers for better defaults.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h2>
<p>Log levels are controlled on a per-module basis, and by default all logging is disabled except for errors. Logging is
controlled via the <code>RUST_LOG</code> environment variable. The value of this environment variable is a comma-separated list of
logging directives.</p>
<p>This will enable debug logging for all modules:</p>
<pre><code class="language-bash">export RUST_LOG=debug
martin postgresql://postgres@localhost/db
</code></pre>
<p>While this will only enable verbose logging for the <code>actix_web</code> module and enable debug logging for the <code>martin</code>
and <code>tokio_postgres</code> modules:</p>
<pre><code class="language-bash">export RUST_LOG=actix_web=info,martin=debug,tokio_postgres=debug
martin postgresql://postgres@localhost/db
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="configuration-file"><a class="header" href="#configuration-file">Configuration File</a></h1>
<p>If you don’t want to expose all of your tables and functions, you can list your sources in a configuration file. To
start Martin with a configuration file you need to pass a path to a file with a <code>--config</code> argument. Config files may
contain environment variables, which will be expanded before parsing. For example, to use <code>MY_DATABASE_URL</code> in your
config file: <code>connection_string: ${MY_DATABASE_URL}</code>, or with a
default <code>connection_string: ${MY_DATABASE_URL:-postgresql://postgres@localhost/db}</code></p>
<pre><code class="language-bash">martin --config config.yaml
</code></pre>
<p>You may wish to auto-generate a config file with <code>--save-config</code> argument. This will generate a config yaml file with
all of your configuration, which you can edit to remove any sources you don’t want to expose.</p>
<pre><code class="language-bash">martin  ... ... ...  --save-config config.yaml
</code></pre>
<h2 id="config-example"><a class="header" href="#config-example">Config Example</a></h2>
<pre><code class="language-yaml"># Connection keep alive timeout [default: 75]
keep_alive: 75

# The socket address to bind [default: 0.0.0.0:3000]
listen_addresses: '0.0.0.0:3000'

# Set TileJSON URL path prefix. This overrides the default of respecting the X-Rewrite-URL header.
# Only modifies the JSON (TileJSON) returned, martins' API-URLs remain unchanged. If you need to rewrite URLs, please use a reverse proxy.
# Must begin with a `/`.
# Examples: `/`, `/tiles`
base_path: /tiles

# Number of web server workers
worker_processes: 8

# Amount of memory (in MB) to use for caching tiles [default: 512, 0 to disable]
cache_size_mb: 1024

# If the client accepts multiple compression formats, and the tile source is not pre-compressed, which compression should be used. `gzip` is faster, but `brotli` is smaller, and may be faster with caching.  Default could be different depending on Martin version.
preferred_encoding: gzip

# Enable or disable Martin web UI. At the moment, only allows `enable-for-all` which enables the web UI for all connections. This may be undesirable in a production environment. [default: disable]
web_ui: disable

# Database configuration. This can also be a list of PG configs.
postgres:
  # Database connection string. You can use env vars too, for example:
  #   $DATABASE_URL
  #   ${DATABASE_URL:-postgresql://postgres@localhost/db}
  connection_string: 'postgresql://postgres@localhost:5432/db'

  # Same as PGSSLCERT for psql
  ssl_cert: './postgresql.crt'
  # Same as PGSSLKEY for psql
  ssl_key: './postgresql.key'
  # Same as PGSSLROOTCERT for psql
  ssl_root_cert: './root.crt'

  #  If a spatial table has SRID 0, then this SRID will be used as a fallback
  default_srid: 4326

  # Maximum Postgres connections pool size [default: 20]
  pool_size: 20

  # Limit the number of geo features per tile.
  #
  # If the source table has more features than set here, they will not be included in the tile and the result will look "cut off"/incomplete.
  # This feature allows to put a maximum latency bound on tiles with extreme amount of detail at the cost of not returning all data.
  # It is sensible to set this limit if you have user generated/untrusted geodata, e.g. a lot of data points at [Null Island](https://en.wikipedia.org/wiki/Null_Island).
  max_feature_count: null # either a positive integer, or null=unlimited (default)

  # Control the automatic generation of bounds for spatial tables [default: quick]
  # 'calc' - compute table geometry bounds on startup.
  # 'quick' - same as 'calc', but the calculation will be aborted if it takes more than 5 seconds.
  # 'skip' - do not compute table geometry bounds on startup.
  auto_bounds: skip

  # Enable automatic discovery of tables and functions.
  # You may set this to `false` to disable.
  auto_publish:
    # Optionally limit to just these schemas
    from_schemas:
      - public
      - my_schema
    # Here we enable both tables and functions auto discovery.
    # You can also enable just one of them by not mentioning the other,
    # or setting it to false.  Setting one to true disables the other one as well.
    # E.g. `tables: false` enables just the functions auto-discovery.
    tables:
      # Optionally set how source ID should be generated based on the table's name, schema, and geometry column
      source_id_format: 'table.{schema}.{table}.{column}'
      # Add more schemas to the ones listed above
      from_schemas: my_other_schema
      # A table column to use as the feature ID
      # If a table has no column with this name, `id_column` will not be set for that table.
      # If a list of strings is given, the first found column will be treated as a feature ID.
      id_columns: feature_id
      # Boolean to control if geometries should be clipped or encoded as is, optional, default to true
      clip_geom: true
      # Buffer distance in tile coordinate space to optionally clip geometries, optional, default to 64
      buffer: 64
      # Tile extent in tile coordinate space, optional, default to 4096
      extent: 4096
    functions:
      # Optionally set how source ID should be generated based on the function's name and schema
      source_id_format: '{schema}.{function}'

  # Associative arrays of table sources
  tables:
    table_source_id:
      # ID of the MVT layer (optional, defaults to table name)
      layer_id: table_source

      # Table schema (required)
      schema: public

      # Table name (required)
      table: table_source

      # Geometry SRID (required)
      srid: 4326

      # Geometry column name (required)
      geometry_column: geom

      # Feature id column name
      id_column: ~

      # An integer specifying the minimum zoom level
      minzoom: 0

      # An integer specifying the maximum zoom level. MUST be &gt;= minzoom
      maxzoom: 30

      # The maximum extent of available map tiles. Bounds MUST define an area
      # covered by all zoom levels. The bounds are represented in WGS:84
      # latitude and longitude values, in the order left, bottom, right, top.
      # Values may be integers or floating point numbers.
      bounds: [ -180.0, -90.0, 180.0, 90.0 ]

      # Tile extent in tile coordinate space
      extent: 4096

      # Buffer distance in tile coordinate space to optionally clip geometries
      buffer: 64

      # Boolean to control if geometries should be clipped or encoded as is
      clip_geom: true

      # Geometry type
      geometry_type: GEOMETRY

      # List of columns, that should be encoded as tile properties (required)
      properties:
        gid: int4

  # Associative arrays of function sources
  functions:
    function_source_id:
      # Schema name (required)
      schema: public

      # Function name (required)
      function: function_zxy_query

      # An integer specifying the minimum zoom level
      minzoom: 0

      # An integer specifying the maximum zoom level. MUST be &gt;= minzoom
      maxzoom: 30

      # The maximum extent of available map tiles. Bounds MUST define an area
      # covered by all zoom levels. The bounds are represented in WGS:84
      # latitude and longitude values, in the order left, bottom, right, top.
      # Values may be integers or floating point numbers.
      bounds: [ -180.0, -90.0, 180.0, 90.0 ]

# Publish PMTiles files from local disk or proxy to a web server
pmtiles:
  paths:
    # scan this whole dir, matching all *.pmtiles files
    - /dir-path
    # specific pmtiles file will be published as a pmt source (filename without extension)
    - /path/to/pmt.pmtiles
    # A web server with a PMTiles file that supports range requests
    - https://example.org/path/tiles.pmtiles
  sources:
    # named source matching source name to a single file
    pm-src1: /path/to/pmt.pmtiles
    # A named source to a web server with a PMTiles file that supports range requests
    pm-web2: https://example.org/path/tiles.pmtiles

# Publish MBTiles files
mbtiles:
  paths:
    # scan this whole dir, matching all *.mbtiles files
    - /dir-path
    # specific mbtiles file will be published as mbtiles2 source
    - /path/to/mbtiles.mbtiles
  sources:
    # named source matching source name to a single file
    mb-src1: /path/to/mbtiles1.mbtiles

# Cloud Optimized GeoTIFF File Sources
cog:
  paths:
    # scan this whole dir, matching all *.tif and *.tiff files
    - /dir-path
    # specific TIFF file will be published as a cog source
    - /path/to/cogfile1.tif
    - /path/to/cogfile2.tiff
  sources:
    # named source matching source name to a single file
     cog-src1: /path/to/cog1.tif
     cog-src2: /path/to/cog2.tif

# Sprite configuration
sprites:
  paths:
    # all SVG files in this dir will be published as a "my_images" sprite source
    - /path/to/my_images
  sources:
    # SVG images in this directory will be published as a "my_sprites" sprite source
    my_sprites: /path/to/some_dir

# Font configuration
fonts:
  # A list of *.otf, *.ttf, and *.ttc font files and dirs to search recursively.
  - /path/to/font/file.ttf
  - /path/to/font_dir
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="postgresql-connection-string"><a class="header" href="#postgresql-connection-string">PostgreSQL Connection String</a></h2>
<p>Martin supports many of the PostgreSQL connection string settings such as <code>host</code>, <code>port</code>, <code>user</code>, <code>password</code>, <code>dbname</code>, <code>sslmode</code>, <code>connect_timeout</code>, <code>keepalives</code>, <code>keepalives_idle</code>, etc. See the <a href="https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-CONNSTRING">PostgreSQL docs</a> for more details.</p>
<h3 id="postgresql-ssl-connections"><a class="header" href="#postgresql-ssl-connections">PostgreSQL SSL Connections</a></h3>
<p>Martin supports PostgreSQL <code>sslmode</code> including <code>disable</code>, <code>prefer</code>, <code>require</code>, <code>verify-ca</code> and <code>verify-full</code> modes as described in the <a href="https://www.postgresql.org/docs/current/libpq-ssl.html">PostgreSQL docs</a>.  Certificates can be provided in the configuration file, or can be set using the same env vars as used for <code>psql</code>. When set as env vars, they apply to all PostgreSQL connections.  See <a href="env-vars.html">environment vars</a> section for more details.</p>
<p>By default, <code>sslmode</code> is set to <code>prefer</code> which means that SSL is used if the server supports it, but the connection is not aborted if the server does not support it.  This is the default behavior of <code>psql</code> and is the most compatible option.  Use the <code>sslmode</code> param to set a different <code>sslmode</code>, e.g. <code>postgresql://user:password@host/db?sslmode=require</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="table-sources"><a class="header" href="#table-sources">Table Sources</a></h2>
<p>Table Source is a database table which can be used to query <a href="https://github.com/mapbox/vector-tile-spec">vector tiles</a>. If a <a href="pg-connections.html">PostgreSQL connection string</a> is given, Martin will publish all tables as data sources if they have at least one geometry column. If geometry column SRID is 0, a default SRID must be set, or else that geo-column/table will be ignored. All non-geometry table columns will be published as vector tile feature tags (properties).</p>
<h3 id="modifying-tilejson"><a class="header" href="#modifying-tilejson">Modifying Tilejson</a></h3>
<p>Martin will automatically generate a <code>TileJSON</code> manifest for each table source. It will contain the <code>name</code>, <code>description</code>, <code>minzoom</code>, <code>maxzoom</code>, <code>bounds</code> and <code>vector_layer</code> information.
For example, if there is a table <code>public.table_source</code>:
the default <code>TileJSON</code> might look like this (note that URL will be automatically adjusted to match the request host):</p>
<p>The table:</p>
<pre><code class="language-sql">CREATE TABLE "public"."table_source" ( "gid" int4 NOT NULL, "geom" "public"."geometry" );
</code></pre>
<p>The TileJSON:</p>
<pre><code class="language-json">{
    "tilejson": "3.0.0",
    "tiles": [
        "http://localhost:3000/table_source/{z}/{x}/{y}"
    ],
    "vector_layers": [
        {
            "id": "table_source",
            "fields": {
                "gid": "int4"
            }
        }
    ],
    "bounds": [
        -2.0,
        -1.0,
        142.84131509869133,
        45.0
    ],
    "description": "public.table_source.geom",
    "name": "table_source"
}
</code></pre>
<p>By default the <code>description</code> and <code>name</code> is database identifies about this table, and the bounds is queried from database. You can fine tune these by adjusting <code>auto_publish</code> section in <a href="https://maplibre.org/martin/config-file.html#config-example">configuration file</a>.</p>
<h4 id="tilejson-in-sql-comments"><a class="header" href="#tilejson-in-sql-comments">TileJSON in SQL Comments</a></h4>
<p>Other than adjusting <code>auto_publish</code> section in configuration file, you can fine tune the <code>TileJSON</code> on the database side directly: Add a valid JSON as an SQL comment on the table.</p>
<p>Martin will merge table comment into the generated TileJSON using JSON Merge patch. The following example update description and adds attribution, version, foo(even a nested DIY field) fields to the TileJSON.</p>
<pre><code class="language-sql">DO $do$ BEGIN
    EXECUTE 'COMMENT ON TABLE table_source IS $tj$' || $$
    {
        "version": "1.2.3",
        "attribution": "osm",
        "description": "a description from table comment",
        "foo": {"bar": "foo"}
    }
    $$::json || '$tj$';
END $do$;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="postgresql-function-sources"><a class="header" href="#postgresql-function-sources">PostgreSQL Function Sources</a></h2>
<p>Function Source is a database function which can be used to
query <a href="https://github.com/mapbox/vector-tile-spec">vector tiles</a>. When started, Martin will look for the functions with
a suitable signature. A function that takes <code>z integer</code> (or <code>zoom integer</code>), <code>x integer</code>, <code>y integer</code>, and an
optional <code>query json</code> and returns <code>bytea</code>, can be used as a Function Source. Alternatively the function could return a
record with a single <code>bytea</code> field, or a record with two fields of types <code>bytea</code> and <code>text</code>, where the <code>text</code> field is
an etag key (i.e. md5 hash).</p>
<div class="table-wrapper"><table><thead><tr><th>Argument</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>z (or zoom)</td><td>integer</td><td>Tile zoom parameter</td></tr>
<tr><td>x</td><td>integer</td><td>Tile x parameter</td></tr>
<tr><td>y</td><td>integer</td><td>Tile y parameter</td></tr>
<tr><td>query (optional, any name)</td><td>json</td><td>Query string parameters</td></tr>
</tbody></table>
</div>
<h3 id="simple-function"><a class="header" href="#simple-function">Simple Function</a></h3>
<p>For example, if you have a table <code>table_source</code> in WGS84 (<code>4326</code> SRID), then you can use this function as a Function
Source:</p>
<pre><code class="language-sql  ignore">CREATE OR REPLACE
    FUNCTION function_zxy_query(z integer, x integer, y integer)
    RETURNS bytea AS $$
DECLARE
  mvt bytea;
BEGIN
  SELECT INTO mvt ST_AsMVT(tile, 'function_zxy_query', 4096, 'geom') FROM (
    SELECT
      ST_AsMVTGeom(
          ST_Transform(ST_CurveToLine(geom), 3857),
          ST_TileEnvelope(z, x, y),
          4096, 64, true) AS geom
    FROM table_source
    WHERE geom &amp;&amp; ST_Transform(ST_TileEnvelope(z, x, y), 4326)
  ) as tile WHERE geom IS NOT NULL;

  RETURN mvt;
END
$$ LANGUAGE plpgsql IMMUTABLE STRICT PARALLEL SAFE;
</code></pre>
<h3 id="function-with-query-parameters"><a class="header" href="#function-with-query-parameters">Function with Query Parameters</a></h3>
<p>Users may add a <code>query</code> parameter to pass additional parameters to the function.</p>
<p><em><strong>TODO</strong>: Modify this example to actually use the query parameters.</em></p>
<pre><code class="language-sql  ignore">CREATE OR REPLACE
    FUNCTION function_zxy_query(z integer, x integer, y integer, query_params json)
    RETURNS bytea AS $$
DECLARE
  mvt bytea;
BEGIN
  SELECT INTO mvt ST_AsMVT(tile, 'function_zxy_query', 4096, 'geom') FROM (
    SELECT
      ST_AsMVTGeom(
          ST_Transform(ST_CurveToLine(geom), 3857),
          ST_TileEnvelope(z, x, y),
          4096, 64, true) AS geom
    FROM table_source
    WHERE geom &amp;&amp; ST_Transform(ST_TileEnvelope(z, x, y), 4326)
  ) as tile WHERE geom IS NOT NULL;

  RETURN mvt;
END
$$ LANGUAGE plpgsql IMMUTABLE STRICT PARALLEL SAFE;
</code></pre>
<p>The <code>query_params</code> argument is a JSON representation of the tile request query params. Query params could be passed as
simple query values, e.g.</p>
<pre><code class="language-bash">curl localhost:3000/function_zxy_query/0/0/0?token=martin
</code></pre>
<p>You can also
use <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent">urlencoded</a>
params to encode complex values:</p>
<pre><code class="language-bash">curl \
  --data-urlencode 'arrayParam=[1, 2, 3]' \
  --data-urlencode 'numberParam=42' \
  --data-urlencode 'stringParam=value' \
  --data-urlencode 'booleanParam=true' \
  --data-urlencode 'objectParam={"answer" : 42}' \
  --get localhost:3000/function_zxy_query/0/0/0
</code></pre>
<p>then <code>query_params</code> will be parsed as:</p>
<pre><code class="language-json">{
  "arrayParam": [1, 2, 3],
  "numberParam": 42,
  "stringParam": "value",
  "booleanParam": true,
  "objectParam": { "answer": 42 }
}
</code></pre>
<p>You can access this params using <a href="https://www.postgresql.org/docs/current/functions-json.html">json operators</a>:</p>
<pre><code class="language-sql  ignore">...WHERE answer = (query_params-&gt;'objectParam'-&gt;&gt;'answer')::int;
</code></pre>
<h3 id="modifying-tilejson-1"><a class="header" href="#modifying-tilejson-1">Modifying TileJSON</a></h3>
<p>Martin will automatically generate a basic <a href="https://github.com/mapbox/tilejson-spec">TileJSON</a> manifest for each
function source that will contain the name and description of the function, plus optionally <code>minzoom</code>, <code>maxzoom</code>,
and <code>bounds</code> (if they were specified via one of the configuration methods). For example, if there is a
function <code>public.function_zxy_query_jsonb</code>, the default <code>TileJSON</code> might look like this (note that URL will be
automatically adjusted to match the request host):</p>
<pre><code class="language-json">{
  "tilejson": "3.0.0",
  "tiles": [
    "http://localhost:3111/function_zxy_query_jsonb/{z}/{x}/{y}"
  ],
  "name": "function_zxy_query_jsonb",
  "description": "public.function_zxy_query_jsonb"
}
</code></pre>
<h4 id="tilejson-in-sql-comments-1"><a class="header" href="#tilejson-in-sql-comments-1">TileJSON in SQL Comments</a></h4>
<p>To modify automatically generated <code>TileJSON</code>, you can add a valid JSON as an SQL comment on the function. Martin will
merge function comment into the generated <code>TileJSON</code> using <a href="https://www.rfc-editor.org/rfc/rfc7386">JSON Merge patch</a>.
The following example adds <code>attribution</code> and <code>version</code> fields to the <code>TileJSON</code>.</p>
<p><strong>Note:</strong> This example uses <code>EXECUTE</code> to ensure that the comment is a valid JSON (or else PostgreSQL will throw an
error). You can use other methods of creating SQL comments.</p>
<pre><code class="language-sql">DO $do$ BEGIN
    EXECUTE 'COMMENT ON FUNCTION my_function_name IS $tj$' || $$
    {
        "description": "my new description",
        "attribution": "my attribution",
        "vector_layers": [
            {
                "id": "my_layer_id",
                "fields": {
                    "field1": "String",
                    "field2": "Number"
                }
            }
        ]
    }
    $$::json || '$tj$';
END $do$;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="mbtiles-and-pmtiles-file-sources"><a class="header" href="#mbtiles-and-pmtiles-file-sources">MBTiles and PMTiles File Sources</a></h2>
<p>Martin can serve any type of tiles from <a href="https://protomaps.com/blog/pmtiles-v3-whats-new">PMTile</a>
and <a href="https://github.com/mapbox/mbtiles-spec">MBTile</a> files. To serve a file from CLI, simply put the path to the file or
the directory with <code>*.mbtiles</code> or <code>*.pmtiles</code> files. A path to PMTiles file may be a URL. For example:</p>
<pre><code class="language-bash">martin  /path/to/mbtiles/file.mbtiles  /path/to/directory   https://example.org/path/tiles.pmtiles
</code></pre>
<p>You may also want to generate a <a href="config-file.html">config file</a> using the <code>--save-config my-config.yaml</code>, and later edit
it and use it with <code>--config my-config.yaml</code> option.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="composite-sources"><a class="header" href="#composite-sources">Composite Sources</a></h2>
<p>Composite Sources allows combining multiple sources into one. Composite Source consists of multiple sources separated by
comma <code>{source1},...,{sourceN}</code></p>
<p>Each source in a composite source can be accessed with its <code>{source_name}</code> as a <code>source-layer</code> property.</p>
<p>Composite source <a href="https://github.com/mapbox/tilejson-spec">TileJSON</a> endpoint is available
at <code>/{source1},...,{sourceN}</code>, and tiles are available at <code>/{source1},...,{sourceN}/{z}/{x}/{y}</code>.</p>
<p>For example, composite source combining <code>points</code> and <code>lines</code> sources will be available at <code>/points,lines/{z}/{x}/{y}</code></p>
<pre><code class="language-bash"># TileJSON
curl localhost:3000/points,lines

# Whole world as a single tile
curl localhost:3000/points,lines/0/0/0
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="sprite-sources"><a class="header" href="#sprite-sources">Sprite Sources</a></h2>
<p>Given a directory with SVG images, Martin will generate a sprite – a JSON index and a PNG image, for both low and highresolution displays.
The SVG filenames without extension will be used as the sprites’ image IDs (remember that one sprite and thus <code>sprite_id</code> contains multiple images).
The images are searched recursively in the given directory, so subdirectory names will be used as prefixes for the image IDs.
For example <code>icons/bicycle.svg</code> will be available as <code>icons/bicycle</code> sprite image.</p>
<p>The sprite generation is not yet cached, and may require external reverse proxy or CDN for faster operation.
If you would like to improve this, please drop us a pull request.</p>
<h3 id="api"><a class="header" href="#api">API</a></h3>
<p>Martin uses <a href="https://maplibre.org/maplibre-style-spec/sprite/">MapLibre sprites API</a> specification to serve sprites via
several endpoints. The sprite image and index are generated on the fly, so if the sprite directory is updated, the
changes will be reflected immediately.</p>
<p>You can use the <code>/catalog</code> api to see all the <code>&lt;sprite_id&gt;</code>s with their contained sprites.</p>
<h5 id="sprite-png"><a class="header" href="#sprite-png">Sprite PNG</a></h5>
<p><img src="sources-sprites.png" alt="sprite" /></p>
<p><code>GET /sprite/&lt;sprite_id&gt;.png</code> endpoint contains a single PNG sprite image that combines all sources images.
Additionally, there is a high DPI version available at <code>GET /sprite/&lt;sprite_id&gt;@2x.png</code>.</p>
<h5 id="sprite-index"><a class="header" href="#sprite-index">Sprite index</a></h5>
<p><code>/sprite/&lt;sprite_id&gt;.json</code> metadata index describing the position and size of each image inside the sprite. Just like
the PNG, there is a high DPI version available at <code>/sprite/&lt;sprite_id&gt;@2x.json</code>.</p>
<pre><code class="language-json">{
  "bicycle": {
    "height": 15,
    "pixelRatio": 1,
    "width": 15,
    "x": 20,
    "y": 16
  },
  ...
}
</code></pre>
<h5 id="coloring-at-runtime-via-signed-distance-fields-sdfs"><a class="header" href="#coloring-at-runtime-via-signed-distance-fields-sdfs">Coloring at runtime via Signed Distance Fields (SDFs)</a></h5>
<p>If you want to set the color of a sprite at runtime, you will need use the <a href="https://steamcdn-a.akamaihd.net/apps/valve/2007/SIGGRAPH2007_AlphaTestedMagnification.pdf">Signed Distance Fields (SDFs)</a>-endpoints.
For example, maplibre does support the image being modified via the <a href="https://maplibre.org/maplibre-style-spec/layers/#icon-color"><code>icon-color</code></a> and <a href="https://maplibre.org/maplibre-style-spec/layers/#icon-halo-color"><code>icon-halo-color</code></a> properties if using SDFs.</p>
<p>SDFs have the significant <strong>downside of only allowing one color</strong>.
If you want multiple colors, you will need to layer icons on top of each other.</p>
<p>The following APIs are available:</p>
<ul>
<li><code>/sdf_sprite/&lt;sprite_id&gt;.json</code> for getting a sprite index as SDF and</li>
<li><code>/sdf_sprite/&lt;sprite_id&gt;.png</code> for getting sprite PNGs as SDF</li>
</ul>
<h4 id="combining-multiple-sprites"><a class="header" href="#combining-multiple-sprites">Combining Multiple Sprites</a></h4>
<p>Multiple <code>sprite_id</code> values can be combined into one sprite with the same pattern as for tile
joining:  <code>/sprite/&lt;sprite_id1&gt;,&lt;sprite_id2&gt;,...,&lt;sprite_idN&gt;</code>. No ID renaming is done, so identical sprite names will
override one another.</p>
<h3 id="configuring-from-cli"><a class="header" href="#configuring-from-cli">Configuring from CLI</a></h3>
<p>A sprite directory can be configured from the CLI with the <code>--sprite</code> flag. The flag can be used multiple times to
configure multiple sprite directories. The <code>sprite_id</code> of the sprite will be the name of the directory – in the example below,
the sprites will be available at <code>/sprite/sprite_a</code> and <code>/sprite/sprite_b</code>. Use <code>--save-config</code> to save the
configuration to the config file.</p>
<pre><code class="language-bash">martin --sprite /path/to/sprite_a --sprite /path/to/other/sprite_b
</code></pre>
<h3 id="configuring-with-config-file"><a class="header" href="#configuring-with-config-file">Configuring with Config File</a></h3>
<p>A sprite directory can be configured from the config file with the <code>sprite</code> key, similar to
how <a href="config-file.html">MBTiles and PMTiles</a> are configured.</p>
<pre><code class="language-yaml"># Sprite configuration
sprites:
  paths:
    # all SVG files in this directory will be published under the sprite_id "my_images"
    - /path/to/my_images
  sources:
    # SVG images in this directory will be published under the sprite_id "my_sprites"
    my_sprites: /path/to/some_dir
</code></pre>
<p>The sprites are now available at <code>/sprite/my_images,some_dir.png</code>/ …</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="font-sources"><a class="header" href="#font-sources">Font Sources</a></h2>
<p>Martin can serve glyph ranges from <code>otf</code>, <code>ttf</code>, and <code>ttc</code> fonts as needed by MapLibre text rendering. Martin will
generate them dynamically on the fly.
The glyph range generation is not yet cached, and may require external reverse proxy or CDN for faster operation.</p>
<h2 id="api-1"><a class="header" href="#api-1">API</a></h2>
<p>Fonts ranges are available either for a single font, or a combination of multiple fonts. The font names are
case-sensitive and should match the font name in the font file as published in the catalog. Make sure to URL-escape font
names as they usually contain spaces.</p>
<div class="table-wrapper"><table><thead><tr><th></th><th>Font Request</th></tr></thead><tbody>
<tr><td>Pattern</td><td><code>/font/{name}/{start}-{end}</code></td></tr>
<tr><td>Example</td><td><code>/font/Overpass%20Mono%20Bold/0-255</code></td></tr>
</tbody></table>
</div>
<h3 id="composite-font-request"><a class="header" href="#composite-font-request">Composite Font Request</a></h3>
<p>When combining multiple fonts, the glyph range will contain glyphs from the first listed font if available, and fallback
to the next font if the glyph is not available in the first font, etc. The glyph range will be empty if none of the
fonts contain the glyph.</p>
<div class="table-wrapper"><table><thead><tr><th></th><th>Composite Font Request with fallbacks</th></tr></thead><tbody>
<tr><td>Pattern</td><td><code>/font/{name1},…,{nameN}/{start}-{end}</code></td></tr>
<tr><td>Example</td><td><code>/font/Overpass%20Mono%20Bold,Overpass%20Mono%20Light/0-255</code></td></tr>
</tbody></table>
</div>
<h3 id="catalog"><a class="header" href="#catalog">Catalog</a></h3>
<p>Martin will show all available fonts at the <code>/catalog</code> endpoint.</p>
<pre><code class="language-bash">curl http://127.0.0.1:3000/catalog
{
  "fonts": {
    "Overpass Mono Bold": {
      "family": "Overpass Mono",
      "style": "Bold",
      "glyphs": 931,
      "start": 0,
      "end": 64258
    },
    "Overpass Mono Light": {
      "family": "Overpass Mono",
      "style": "Light",
      "glyphs": 931,
      "start": 0,
      "end": 64258
    },
    "Overpass Mono SemiBold": {
      "family": "Overpass Mono",
      "style": "SemiBold",
      "glyphs": 931,
      "start": 0,
      "end": 64258
    }
  }
}
</code></pre>
<h2 id="using-from-cli"><a class="header" href="#using-from-cli">Using from CLI</a></h2>
<p>A font file or directory can be configured from the <a href="run-with-cli.html">CLI</a> with one or more <code>--font</code> parameters.</p>
<pre><code class="language-bash">martin --font /path/to/font/file.ttf --font /path/to/font_dir
</code></pre>
<h2 id="configuring-from-config-file"><a class="header" href="#configuring-from-config-file">Configuring from Config File</a></h2>
<p>A font directory can be configured from the config file with the <code>fonts</code> key.</p>
<pre><code class="language-yaml"># Fonts configuration
fonts:
  # A list of *.otf, *.ttf, and *.ttc font files and dirs to search recursively.
  - /path/to/font/file.ttf
  - /path/to/font_dir
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="martin-endpoints"><a class="header" href="#martin-endpoints">Martin Endpoints</a></h2>
<p>Martin data is available via the HTTP <code>GET</code> endpoints:</p>
<div class="table-wrapper"><table><thead><tr><th>URL</th><th>Description</th></tr></thead><tbody>
<tr><td><code>/</code></td><td>Web UI</td></tr>
<tr><td><code>/catalog</code></td><td><a href="using.html#catalog">List of all sources</a></td></tr>
<tr><td><code>/{sourceID}</code></td><td><a href="using.html#source-tilejson">Source TileJSON</a></td></tr>
<tr><td><code>/{sourceID}/{z}/{x}/{y}</code></td><td>Map Tiles</td></tr>
<tr><td><code>/{source1},…,{sourceN}</code></td><td><a href="using.html#source-tilejson">Composite Source TileJSON</a></td></tr>
<tr><td><code>/{source1},…,{sourceN}/{z}/{x}/{y}</code></td><td><a href="sources-composite.html">Composite Source Tiles</a></td></tr>
<tr><td><code>/sprite/{spriteID}[@2x].{json,png}</code></td><td><a href="sources-sprites.html">Sprite sources</a></td></tr>
<tr><td><code>/sdf_sprite/{spriteID}[@2x].{json,png}</code></td><td><a href="sources-sprites.html">SDF Sprite sources</a></td></tr>
<tr><td><code>/font/{font}/{start}-{end}</code></td><td><a href="sources-fonts.html">Font source</a></td></tr>
<tr><td><code>/font/{font1},…,{fontN}/{start}-{end}</code></td><td><a href="sources-fonts.html">Composite Font source</a></td></tr>
<tr><td><code>/health</code></td><td>Martin server health check: returns 200 <code>OK</code></td></tr>
</tbody></table>
</div>
<h3 id="duplicate-source-id"><a class="header" href="#duplicate-source-id">Duplicate Source ID</a></h3>
<p>In case there is more than one source that has the same name, e.g. a PG function is available in two
schemas/connections, or a table has more than one geometry columns, sources will be assigned unique IDs such
as <code>/points</code>, <code>/points.1</code>, etc.</p>
<h3 id="reserved-source-ids"><a class="header" href="#reserved-source-ids">Reserved Source IDs</a></h3>
<p>Some source IDs are reserved for internal use. If you try to use them, they will be automatically renamed to a unique ID
the same way as duplicate source IDs are handled, e.g. a <code>catalog</code> source will become <code>catalog.1</code>.</p>
<p>Some of the reserved IDs: <code>_</code>, <code>catalog</code>, <code>config</code>, <code>font</code>, <code>health</code>, <code>help</code>, <code>index</code>, <code>manifest</code>, <code>metrics</code>, <code>refresh</code>,
<code>reload</code>, <code>sprite</code>, <code>status</code>.</p>
<h3 id="catalog-1"><a class="header" href="#catalog-1">Catalog</a></h3>
<p>A list of all available sources is available via catalogue endpoint:</p>
<pre><code class="language-bash">curl localhost:3000/catalog | jq
</code></pre>
<pre><code class="language-yaml">{
  "tiles" {
    "function_zxy_query": {
      "name": "public.function_zxy_query",
      "content_type": "application/x-protobuf"
    },
    "points1": {
      "name": "public.points1.geom",
      "content_type": "image/webp"
    },
    ...
  },
  "sprites": {
    "cool_icons": {
      "images": [
        "bicycle",
        "bear",
      ]
    },
    ...
  },
  "fonts": {
    "Noto Mono Regular": {
      "family": "Noto Mono",
      "style": "Regular",
      "glyphs": 875,
      "start": 0,
      "end": 65533
    },
    ...
  }
}
</code></pre>
<h3 id="source-tilejson"><a class="header" href="#source-tilejson">Source TileJSON</a></h3>
<p>All tile sources have a <a href="https://github.com/mapbox/tilejson-spec">TileJSON</a> endpoint available at the <code>/{SourceID}</code>.</p>
<p>For example, a <code>points</code> function or a table will be available as <code>/points</code>. Composite source combining <code>points</code>
and <code>lines</code> sources will be available at <code>/points,lines</code> endpoint.</p>
<pre><code class="language-bash">curl localhost:3000/points | jq
curl localhost:3000/points,lines | jq
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="using-with-maplibre"><a class="header" href="#using-with-maplibre">Using with MapLibre</a></h2>
<p><a href="https://maplibre.org/maplibre-gl-js/docs/">MapLibre</a> is an Open-source JavaScript library for showing maps on a
website. MapLibre can accept <a href="https://github.com/mapbox/vector-tile-spec">MVT vector tiles</a> generated by Martin, and
applies <a href="https://maplibre.org/maplibre-style-spec/">a style</a> to them to draw a map using Web GL.</p>
<p>You can add a layer to the map and specify Martin <a href="https://github.com/mapbox/tilejson-spec">TileJSON</a> endpoint as a
vector source URL. You should also specify a <code>source-layer</code> property. For <a href="sources-pg-tables.html">Table Sources</a> it
is <code>{table_name}</code> by default.</p>
<pre><code class="language-js">map.addLayer({
    id: 'points',
    type: 'circle',
    source: {
        type: 'vector',
        url: 'http://localhost:3000/points'
    },
    'source-layer': 'points',
    paint: {
        'circle-color': 'red'
    },
});
</code></pre>
<pre><code class="language-js">map.addSource('rpc', {
    type: 'vector',
    url: `http://localhost:3000/function_zxy_query`
});
map.addLayer({
    id: 'points',
    type: 'circle',
    source: 'rpc',
    'source-layer': 'function_zxy_query',
    paint: {
        'circle-color': 'blue'
    },
});
</code></pre>
<p>You can also combine multiple sources into one source with <a href="sources-composite.html">Composite Sources</a>. Each source in a
composite source can be accessed with its <code>{source_name}</code> as a <code>source-layer</code> property.</p>
<pre><code class="language-js">map.addSource('points', {
    type: 'vector',
    url: `http://0.0.0.0:3000/points1,points2`
});

map.addLayer({
    id: 'red_points',
    type: 'circle',
    source: 'points',
    'source-layer': 'points1',
    paint: {
        'circle-color': 'red'
    }
});

map.addLayer({
    id: 'blue_points',
    type: 'circle',
    source: 'points',
    'source-layer': 'points2',
    paint: {
        'circle-color': 'blue'
    }
});
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="using-with-leaflet"><a class="header" href="#using-with-leaflet">Using with Leaflet</a></h2>
<p><a href="https://github.com/Leaflet/Leaflet">Leaflet</a> is the leading open-source JavaScript library for mobile-friendly interactive maps.</p>
<p>You can add vector tiles using <a href="https://github.com/Leaflet/Leaflet.VectorGrid">Leaflet.VectorGrid</a> plugin. You must initialize a <a href="https://leaflet.github.io/Leaflet.VectorGrid/vectorgrid-api-docs.html#vectorgrid-protobuf">VectorGrid.Protobuf</a> with a URL template, just like in L.TileLayers. The difference is that you should define the styling for all the features.</p>
<pre><code class="language-js">L.vectorGrid
  .protobuf('http://localhost:3000/points/{z}/{x}/{y}', {
    vectorTileLayerStyles: {
      'points': {
        color: 'red',
        fill: true
      }
    }
  })
  .addTo(map);
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="using-with-deckgl"><a class="header" href="#using-with-deckgl">Using with deck.gl</a></h2>
<p><a href="https://deck.gl/">deck.gl</a> is a WebGL-powered framework for visual exploratory data analysis of large datasets.</p>
<p>You can add vector tiles using <a href="https://deck.gl/docs/api-reference/geo-layers/mvt-layer">MVTLayer</a>. MVTLayer <code>data</code> property defines the remote data for the MVT layer. It can be</p>
<ul>
<li><code>String</code>: Either a URL template or a <a href="https://github.com/mapbox/tilejson-spec">TileJSON</a> URL.</li>
<li><code>Array</code>: an array of URL templates. It allows to balance the requests across different tile endpoints. For example, if you define an array with 4 urls and 16 tiles need to be loaded, each endpoint is responsible to server 16/4 tiles.</li>
<li><code>JSON</code>: A valid <a href="https://github.com/mapbox/tilejson-spec/tree/master/2.2.0">TileJSON object</a>.</li>
</ul>
<pre><code class="language-js">const pointsLayer = new MVTLayer({
  data: 'http://localhost:3000/points',
  pointRadiusUnits: 'pixels',
  getRadius: 5,
  getFillColor: [230, 0, 0]
});

const deckgl = new DeckGL({
  container: 'map',
  mapStyle: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
  initialViewState: {
    latitude: 0,
    longitude: 0,
    zoom: 1
  },
  layers: [pointsLayer]
});
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="using-with-mapbox"><a class="header" href="#using-with-mapbox">Using with Mapbox</a></h2>
<p><a href="https://github.com/mapbox/mapbox-gl-js">Mapbox GL JS</a> is a JavaScript library for interactive, customizable vector maps
on the web. Mapbox GL JS v1.x was open source, and it was forked as MapLibre, so using Martin with Mapbox is similar to
MapLibre described <a href="using-with-maplibre.html">here</a>. Mapbox GL JS can
accept <a href="https://github.com/mapbox/vector-tile-spec">MVT vector tiles</a> generated by Martin, and
applies <a href="https://maplibre.org/maplibre-style-spec/">a style</a> to them to draw a map using Web GL.</p>
<p>You can add a layer to the map and specify Martin TileJSON endpoint as a vector source URL. You should also specify
a <code>source-layer</code> property. For <a href="sources-pg-tables.html">Table Sources</a> it is <code>{table_name}</code> by default.</p>
<pre><code class="language-js">map.addLayer({
    id: 'points',
    type: 'circle',
    source: {
        type: 'vector',
        url: 'http://localhost:3000/points'
    },
    'source-layer': 'points',
    paint: {
        'circle-color': 'red'
    }
});
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="using-with-openlayers"><a class="header" href="#using-with-openlayers">Using with OpenLayers</a></h2>
<p><a href="https://github.com/openlayers/openlayers">OpenLayers</a> is an open source library for creating interactive maps on the web. Similar to <a href="https://maplibre.org/">MapLibre GL JS</a>, it can also display image and vector map tiles served by Martin Tile Server.</p>
<p>You can integrate tile services from <code>martin</code> and <code>OpenLayers</code> with its <a href="https://openlayers.org/en/latest/apidoc/module-ol_layer_VectorTile-VectorTileLayer.html">VectorTileLayer</a>. Here is an example to add <code>MixPoints</code> vector tile source to an OpenLayers map.</p>
<pre><code class="language-js">const layer = new VectorTileLayer({
    source: new VectorTileSource({
        format: new MVT(),
        url: 'http://0.0.0.0:3000/MixPoints/{z}/{x}/{y}',
        maxZoom: 14,
    }),
});
map.addLayer(layer);
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="recipes"><a class="header" href="#recipes">Recipes</a></h2>
<h3 id="using-with-digitalocean-postgresql"><a class="header" href="#using-with-digitalocean-postgresql">Using with DigitalOcean PostgreSQL</a></h3>
<p>You can use Martin
with <a href="https://www.digitalocean.com/products/managed-databases-postgresql/">Managed PostgreSQL from DigitalOcean</a> with
PostGIS extension</p>
<p>First, you need to download the CA certificate and get your cluster connection string from
the <a href="https://cloud.digitalocean.com/databases">dashboard</a>. After that, you can use the connection string and the CA
certificate to connect to the database</p>
<pre><code class="language-bash">martin --ca-root-file ./ca-certificate.crt \
       postgresql://user:password@host:port/db?sslmode=require
</code></pre>
<h3 id="using-with-heroku-postgresql"><a class="header" href="#using-with-heroku-postgresql">Using with Heroku PostgreSQL</a></h3>
<p>You can use Martin with <a href="https://www.heroku.com/postgres">Managed PostgreSQL from Heroku</a> with PostGIS extension</p>
<pre><code class="language-bash">heroku pg:psql -a APP_NAME -c 'create extension postgis'
</code></pre>
<p>Use the same environment variables as
Heroku <a href="https://devcenter.heroku.com/articles/heroku-postgres-via-mtls#step-2-configure-environment-variables">suggests for psql</a>.</p>
<pre><code class="language-bash">export DATABASE_URL=$(heroku config:get DATABASE_URL -a APP_NAME)
export PGSSLCERT=DIRECTORY/PREFIXpostgresql.crt
export PGSSLKEY=DIRECTORY/PREFIXpostgresql.key
export PGSSLROOTCERT=DIRECTORY/PREFIXroot.crt

martin
</code></pre>
<p>You may also be able to validate SSL certificate with an explicit sslmode, e.g.</p>
<pre><code class="language-bash">export DATABASE_URL="$(heroku config:get DATABASE_URL -a APP_NAME)?sslmode=verify-ca"
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cli-tools"><a class="header" href="#cli-tools">CLI Tools</a></h1>
<p>Martin project contains additional tooling to help manage the data servable with Martin tile server.</p>
<h2 id="martin-cp"><a class="header" href="#martin-cp"><code>martin-cp</code></a></h2>
<p><code>martin-cp</code> is a tool for generating tiles in bulk, and save retrieved tiles into a new or an existing MBTiles file. It can be used to generate tiles for a large area or multiple areas. If multiple areas overlap, it will generate tiles only once. <code>martin-cp</code> supports the same configuration file and CLI arguments as Martin server, so it can support all sources and even combining sources.</p>
<h2 id="mbtiles"><a class="header" href="#mbtiles"><code>mbtiles</code></a></h2>
<p><code>mbtiles</code> is a small utility to interact with the <code>*.mbtiles</code> files from the command line. It allows users to examine, copy, validate, compare, and apply diffs between them.</p>
<p>Use <code>mbtiles --help</code> to see a list of available commands, and <code>mbtiles &lt;command&gt; --help</code> to see help for a specific command.</p>
<p>This tool can be installed by compiling the latest released version with <code>cargo install mbtiles --locked</code>, or by downloading a pre-built binary from the <a href="https://github.com/maplibre/martin/releases/latest">releases page</a>.</p>
<p>The <code>mbtiles</code> utility builds on top of the <a href="https://github.com/mapbox/mbtiles-spec">MBTiles specification</a>. It adds a few additional conventions to ensure that the content of the tile data is valid, and can be used for reliable diffing and patching of the tilesets.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="generating-tiles-in-bulk"><a class="header" href="#generating-tiles-in-bulk">Generating Tiles in Bulk</a></h1>
<p><code>martin-cp</code> is a tool for generating tiles in bulk, from any source(s) supported by Martin, and save retrieved tiles
into a new or an existing MBTiles file. <code>martin-cp</code> can be used to generate tiles for a large area or multiple areas
(bounding boxes). If multiple areas overlap, it will ensure each tile is generated only once. <code>martin-cp</code> supports the
same configuration file and CLI arguments as Martin server, so it can support all sources and even combining sources.</p>
<p>After copying, <code>martin-cp</code> will update the <code>agg_tiles_hash</code> metadata value unless <code>--skip-agg-tiles-hash</code> is specified.
This allows the MBTiles file to be <a href="./mbtiles-validation.html#aggregate-content-validation">validated</a>
using <code>mbtiles validate</code> command.</p>
<h2 id="usage-1"><a class="header" href="#usage-1">Usage</a></h2>
<p>This copies tiles from a PostGIS table <code>my_table</code> into an MBTiles file <code>tileset.mbtiles</code>
using <a href="mbtiles-schema.html">normalized</a> schema, with zoom levels from 0 to 10, and bounds of the whole world.</p>
<pre><code class="language-bash">martin-cp  --output-file tileset.mbtiles \
           --mbtiles-type normalized     \
           "--bbox=-180,-90,180,90"      \
           --min-zoom 0                  \
           --max-zoom 10                 \
           --source source_name          \
           postgresql://postgres@localhost:5432/db
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mbtiles-information-and-metadata"><a class="header" href="#mbtiles-information-and-metadata">MBTiles information and metadata</a></h1>
<h2 id="summary"><a class="header" href="#summary">summary</a></h2>
<p>Use <code>mbtiles summary</code> to get a summary of the contents of an MBTiles file. The command will print a table with the
number of tiles per zoom level, the size of the smallest and largest tiles, and the average size of tiles at each zoom
level. The command will also print the bounding box of the covered area per zoom level.</p>
<pre><code class="language-bash">MBTiles file summary for tests/fixtures/mbtiles/world_cities.mbtiles
Schema: flat
File size: 48.00KiB
Page size: 4.00KiB
Page count: 12

 Zoom |   Count   | Smallest  |  Largest  |  Average  | Bounding Box
    0 |         1 |    1.0KiB |    1.0KiB |    1.0KiB | -180,-85,180,85
    1 |         4 |      160B |      650B |      366B | -180,-85,180,85
    2 |         7 |      137B |      495B |      239B | -180,-67,180,67
    3 |        17 |       67B |      246B |      134B | -135,-41,180,67
    4 |        38 |       64B |      175B |       86B | -135,-41,180,67
    5 |        57 |       64B |      107B |       72B | -124,-41,180,62
    6 |        72 |       64B |       97B |       68B | -124,-41,180,62
  all |       196 |       64B |    1.0KiB |       96B | -180,-85,180,85
</code></pre>
<h2 id="meta-all"><a class="header" href="#meta-all">meta-all</a></h2>
<p>Print all metadata values to stdout, as well as the results of tile detection. The format of the values printed is not
stable, and should only be used for visual inspection.</p>
<pre><code class="language-bash">mbtiles meta-all my_file.mbtiles
</code></pre>
<h2 id="meta-get"><a class="header" href="#meta-get">meta-get</a></h2>
<p>Retrieve raw metadata value by its name. The value is printed to stdout without any modifications. For example, to get
the <code>description</code> value from an mbtiles file:</p>
<pre><code class="language-bash">mbtiles meta-get my_file.mbtiles description
</code></pre>
<h2 id="meta-set"><a class="header" href="#meta-set">meta-set</a></h2>
<p>Set metadata value by its name, or delete the key if no value is supplied. For example, to set the <code>description</code> value
to <code>A vector tile dataset</code>:</p>
<pre><code class="language-bash">mbtiles meta-set my_file.mbtiles description "A vector tile dataset"
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mbtiles-schemas"><a class="header" href="#mbtiles-schemas">MBTiles Schemas</a></h1>
<p>The <code>mbtiles</code> tool builds on top of the original <a href="https://github.com/mapbox/mbtiles-spec#readme">MBTiles specification</a> by specifying three different kinds of schema for <code>tiles</code> data: <code>flat</code>, <code>flat-with-hash</code>, and <code>normalized</code>. The <code>mbtiles</code> tool can convert between these schemas, and can also generate a diff between two files of any schemas, as well as merge multiple schema files into one file.</p>
<h2 id="flat"><a class="header" href="#flat">flat</a></h2>
<p>Flat schema is the closest to the original MBTiles specification. It stores all tiles in a single table. This schema is the most efficient when the tileset contains no duplicate tiles.</p>
<pre><code class="language-sql  ignore">CREATE TABLE tiles (
    zoom_level  INTEGER,
    tile_column INTEGER,
    tile_row    INTEGER,
    tile_data   BLOB);

CREATE UNIQUE INDEX tile_index on tiles (
    zoom_level, tile_column, tile_row);
</code></pre>
<h2 id="flat-with-hash"><a class="header" href="#flat-with-hash">flat-with-hash</a></h2>
<p>Similar to the <code>flat</code> schema, but also includes a <code>tile_hash</code> column that contains a hash value of the <code>tile_data</code> column. Use this schema when the tileset has no duplicate tiles, but you still want to be able to validate the content of each tile individually.</p>
<pre><code class="language-sql  ignore">CREATE TABLE tiles_with_hash (
    zoom_level  INTEGER NOT NULL,
    tile_column INTEGER NOT NULL,
    tile_row    INTEGER NOT NULL,
    tile_data   BLOB,
    tile_hash   TEXT);

CREATE UNIQUE INDEX tiles_with_hash_index on tiles_with_hash (
    zoom_level, tile_column, tile_row);

CREATE VIEW tiles AS
    SELECT zoom_level, tile_column, tile_row, tile_data
    FROM tiles_with_hash;
</code></pre>
<h2 id="normalized"><a class="header" href="#normalized">normalized</a></h2>
<p>Normalized schema is the most efficient when the tileset contains duplicate tiles. It stores all tile blobs in the <code>images</code> table, and stores the tile Z,X,Y coordinates in a <code>map</code> table. The <code>map</code> table contains a <code>tile_id</code> column that is a foreign key to the <code>images</code> table. The <code>tile_id</code> column is a hash of the <code>tile_data</code> column, making it possible to both validate each individual tile like in the <code>flat-with-hash</code> schema, and also to optimize storage by storing each unique tile only once.</p>
<pre><code class="language-sql  ignore">CREATE TABLE map (
    zoom_level  INTEGER,
    tile_column INTEGER,
    tile_row    INTEGER,
    tile_id     TEXT);

CREATE TABLE images (
    tile_id   TEXT,
    tile_data BLOB);

CREATE UNIQUE INDEX map_index ON map (
    zoom_level, tile_column, tile_row);
CREATE UNIQUE INDEX images_id ON images (
    tile_id);

CREATE VIEW tiles AS
    SELECT
        map.zoom_level   AS zoom_level,
        map.tile_column  AS tile_column,
        map.tile_row     AS tile_row,
        images.tile_data AS tile_data
    FROM
        map JOIN images
        ON images.tile_id = map.tile_id;
</code></pre>
<p>Optionally, <code>.mbtiles</code> files with <code>normalized</code> schema can include a <code>tiles_with_hash</code> view. All <code>normalized</code> files created by the <code>mbtiles</code> tool will contain this view.</p>
<pre><code class="language-sql  ignore">CREATE VIEW tiles_with_hash AS
    SELECT
        map.zoom_level   AS zoom_level,
        map.tile_column  AS tile_column,
        map.tile_row     AS tile_row,
        images.tile_data AS tile_data,
        images.tile_id   AS tile_hash
    FROM
        map JOIN images
        ON map.tile_id = images.tile_id;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="copying-diffing-and-patching-mbtiles"><a class="header" href="#copying-diffing-and-patching-mbtiles">Copying, Diffing, and Patching MBTiles</a></h1>
<h2 id="mbtiles-copy"><a class="header" href="#mbtiles-copy"><code>mbtiles copy</code></a></h2>
<p>Copy command copies an mbtiles file, optionally filtering its content by zoom levels.</p>
<pre><code class="language-bash">mbtiles copy src_file.mbtiles dst_file.mbtiles \
        --min-zoom 0 --max-zoom 10
</code></pre>
<p>This command can also be used to generate files of different <a href="mbtiles-schema.html">supported schema</a>.</p>
<pre><code class="language-bash">mbtiles copy normalized.mbtiles dst.mbtiles \
         --dst-mbttype flat-with-hash
</code></pre>
<h2 id="mbtiles-copy---diff-with-file"><a class="header" href="#mbtiles-copy---diff-with-file"><code>mbtiles copy --diff-with-file</code></a></h2>
<p>This option is identical to using <a href="mbtiles-diff.html"><code>mbtiles diff ...</code></a>. The following commands two are equivalent:</p>
<pre><code class="language-bash">mbtiles diff file1.mbtiles file2.mbtiles diff.mbtiles

mbtiles copy file1.mbtiles diff.mbtiles \
        --diff-with-file file2.mbtiles
</code></pre>
<h2 id="mbtiles-copy---apply-patch"><a class="header" href="#mbtiles-copy---apply-patch"><code>mbtiles copy --apply-patch</code></a></h2>
<p>Copy a source file to destination while also applying the diff file generated by <code>copy --diff-with-file</code> command above
to the destination mbtiles file. This allows safer application of the diff file, as the source file is not modified.</p>
<pre><code class="language-bash">mbtiles copy src_file.mbtiles dst_file.mbtiles \
        --apply-patch diff.mbtiles
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="diffing-mbtiles"><a class="header" href="#diffing-mbtiles">Diffing MBTiles</a></h1>
<h2 id="mbtiles-diff"><a class="header" href="#mbtiles-diff"><code>mbtiles diff</code></a></h2>
<p>Copy command can also be used to compare two mbtiles files and generate a delta (diff) file. The diff file can
be <a href="mbtiles-diff.html#mbtiles-apply-patch">applied</a> to the <code>src_file.mbtiles</code> elsewhere, to avoid copying/transmitting the entire
modified dataset. The delta file will contain all tiles that are different between the two files (modifications,
insertions, and deletions as <code>NULL</code> values), for both the tile and metadata tables.</p>
<p>There is one exception: <code>agg_tiles_hash</code> metadata value will be renamed to <code>agg_tiles_hash_after_apply</code>, and a
new <code>agg_tiles_hash</code> will be generated for the diff file itself. This is done to avoid confusion when applying the diff
file to the original file, as the <code>agg_tiles_hash</code> value will be different after the diff is applied. The <code>apply-patch</code>
command will automatically rename the <code>agg_tiles_hash_after_apply</code> value back to <code>agg_tiles_hash</code> when applying the
diff.</p>
<pre><code class="language-bash"># This command will compare `file1.mbtiles` and `file2.mbtiles`, and generate a new diff file `diff.mbtiles`.
mbtiles diff file1.mbtiles file2.mbtiles diff.mbtiles

# If diff.mbtiles is applied to file1.mbtiles, it will produce file2.mbtiles
mbtiles apply-patch file1.mbtiles diff.mbtiles file2a.mbtiles

# file2.mbtiles and file2a.mbtiles should now be the same
# Validate both files and see that their hash values are identical
mbtiles validate file2.mbtiles
[INFO ] The agg_tiles_hashes=E95C1081447FB25674DCC1EB97F60C26 has been verified for file2.mbtiles

mbtiles validate file2a.mbtiles
[INFO ] The agg_tiles_hashes=E95C1081447FB25674DCC1EB97F60C26 has been verified for file2a.mbtiles
</code></pre>
<h2 id="mbtiles-apply-patch"><a class="header" href="#mbtiles-apply-patch"><code>mbtiles apply-patch</code></a></h2>
<p>Apply the diff file generated with the <code>mbtiles diff</code> command above to an MBTiles file. The diff file can be applied to
the <code>src_file.mbtiles</code> that has been previously downloaded to avoid copying/transmitting the entire modified dataset
again. The <code>src_file.mbtiles</code> will modified in-place. It is also possible to apply the diff file while copying the
source file to a new destination file, by using
the <a href="mbtiles-copy.html#mbtiles-copy---apply-patch"><code>mbtiles copy --apply-patch</code></a> command.</p>
<p>Note that the <code>agg_tiles_hash_after_apply</code> metadata value will be renamed to <code>agg_tiles_hash</code> when applying the diff.
This is done to avoid confusion when applying the diff file to the original file, as the <code>agg_tiles_hash</code> value will be
different after the diff is applied.</p>
<pre><code class="language-bash">mbtiles apply-patch src_file.mbtiles diff_file.mbtiles
</code></pre>
<h4 id="applying-diff-with-sqlite"><a class="header" href="#applying-diff-with-sqlite">Applying diff with SQLite</a></h4>
<p>Another way to apply the diff is to use the <code>sqlite3</code> command line tool directly. This SQL will delete all tiles
from <code>src_file.mbtiles</code> that are set to <code>NULL</code> in <code>diff_file.mbtiles</code>, and then insert or update all new tiles
from <code>diff_file.mbtiles</code> into <code>src_file.mbtiles</code>, where both files are of <code>flat</code> type. The name of the diff file is
passed as a query parameter to the sqlite3 command line tool, and then used in the SQL statements. Note that this does
not update the <code>agg_tiles_hash</code> metadata value, so it will be incorrect after the diff is applied.</p>
<pre><code class="language-bash">sqlite3 src_file.mbtiles \
  -bail \
  -cmd ".parameter set @diffDbFilename diff_file.mbtiles" \
  "ATTACH DATABASE @diffDbFilename AS diffDb;" \
  "DELETE FROM tiles WHERE (zoom_level, tile_column, tile_row) IN (SELECT zoom_level, tile_column, tile_row FROM diffDb.tiles WHERE tile_data ISNULL);" \
  "INSERT OR REPLACE INTO tiles (zoom_level, tile_column, tile_row, tile_data) SELECT * FROM diffDb.tiles WHERE tile_data NOTNULL;"
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mbtiles-validation"><a class="header" href="#mbtiles-validation">MBTiles Validation</a></h1>
<p>The original <a href="https://github.com/mapbox/mbtiles-spec#readme">MBTiles specification</a> does not provide any guarantees for
the content of the tile data in MBTiles. <code>mbtiles validate</code> assumes a few additional conventions and uses them to ensure
that the content of the tile data is valid performing several validation steps. If the file is not valid, the command
will print an error message and exit with a non-zero exit code.</p>
<pre><code class="language-bash">mbtiles validate src_file.mbtiles
</code></pre>
<h2 id="sqlite-integrity-check"><a class="header" href="#sqlite-integrity-check">SQLite Integrity check</a></h2>
<p>The <code>validate</code> command will run <code>PRAGMA integrity_check</code> on the file, and will fail if the result is not <code>ok</code>.
The <code>--integrity-check</code> flag can be used to disable this check, or to make it more thorough with <code>full</code> value. Default
is <code>quick</code>.</p>
<h2 id="schema-check"><a class="header" href="#schema-check">Schema check</a></h2>
<p>The <code>validate</code> command will verify that the <code>tiles</code> table/view exists, and that it has the expected columns and indexes.
It will also verify that the <code>metadata</code> table/view exists, and that it has the expected columns and indexes.</p>
<h2 id="per-tile-validation"><a class="header" href="#per-tile-validation">Per-tile validation</a></h2>
<p>If the <code>.mbtiles</code> file uses <a href="mbtiles-schema.html#flat-with-hash">flat_with_hash</a>
or <a href="mbtiles-schema.html#normalized">normalized</a> schema, the <code>validate</code> command will verify that the MD5 hash of
the <code>tile_data</code> column matches the  <code>tile_hash</code> or <code>tile_id</code> columns (depending on the schema).</p>
<p>A typical Normalized schema generated by tools like <a href="https://github.com/mapbox/TileLive#bintilelive-copy">tilelive-copy</a>
use MD5 hash in the <code>tile_id</code> column. The Martin’s <code>mbtiles</code> tool can use this hash to verify the content of each tile.
We also define a new <a href="mbtiles-schema.html#flat-with-hash">flat-with-hash</a> schema that stores the hash and tile data in the
same table, allowing per-tile validation without the multiple table layout.</p>
<p>Per-tile validation is not available for the <code>flat</code> schema, and will be skipped.</p>
<h2 id="aggregate-content-validation"><a class="header" href="#aggregate-content-validation">Aggregate Content Validation</a></h2>
<p>Per-tile validation will catch individual tile corruption, but it will not detect overall datastore corruption such as
missing tiles, tiles that should not exist, or tiles with incorrect z/x/y values. For that, the <code>mbtiles</code> tool defines a
new metadata value called <code>agg_tiles_hash</code>.</p>
<p>The value is computed by hashing the combined value for all rows in the <code>tiles</code> table/view, ordered by z,x,y. The value
is computed using the following SQL expression, which uses a custom <code>md5_concat_hex</code> function
from <a href="https://crates.io/crates/sqlite-hashes">sqlite-hashes crate</a>:</p>
<pre><code class="language-sql  ignore">md5_concat_hex(
    CAST(zoom_level  AS TEXT),
    CAST(tile_column AS TEXT),
    CAST(tile_row    AS TEXT),
    tile_data)
</code></pre>
<p>In case there are no rows or all are NULL, the hash value of an empty string is used. Note that SQLite allows any value
type to be stored as in any column, so if <code>tile_data</code> accidentally contains non-blob/text/null value, validation will
fail.</p>
<p>The <code>mbtiles</code> tool will compute <code>agg_tiles_hash</code> value when copying or validating mbtiles files. Use <code>--agg-hash update</code>
to force the value to be updated, even if it is incorrect or does not exist.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="development"><a class="header" href="#development">Development</a></h1>
<p>Clone Martin, setting remote name to <code>upstream</code>. This way <code>main</code> branch will be updated automatically with the latest
changes from the upstream repo.</p>
<pre><code class="language-bash  ignore">git clone https://github.com/maplibre/martin.git -o upstream
cd martin
</code></pre>
<p>Fork Martin repo into your own GitHub account, and add your fork as a remote</p>
<pre><code class="language-bash  ignore">git remote add origin  _URL_OF_YOUR_FORK_
</code></pre>
<p>Install <a href="https://docs.docker.com/get-docker/">docker</a> and <a href="https://docs.docker.com/compose/">docker-compose</a></p>
<pre><code class="language-bash  ignore"># Ubuntu-based distros have an older version that might also work:
sudo apt install -y  docker.io docker-compose
</code></pre>
<p>Install a few required libs and tools:</p>
<pre><code class="language-bash  ignore"># For Ubuntu-based distros
sudo apt install -y  build-essential pkg-config jq file gdal-bin
</code></pre>
<p>Install <a href="https://github.com/casey/just#readme">Just</a> (improved makefile processor). Note that some Linux and Homebrew
distros have outdated versions of Just, so you should install it from source:</p>
<pre><code class="language-bash  ignore">cargo install just --locked
</code></pre>
<p>When developing MBTiles SQL code, you may need to use <code>just prepare-sqlite</code> whenever SQL queries are modified.
Run <code>just</code> to see all available commands.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="getting-involved"><a class="header" href="#getting-involved">Getting involved</a></h1>
<p>It’s time to get involved once you have the <a href="development.html">fork and all required software</a>.</p>
<p>We assume you are working on Ubuntu (or WSL) with Visual Studio Code in this post.</p>
<h2 id="editor-plugins"><a class="header" href="#editor-plugins">Editor Plugins</a></h2>
<p>Install plugins below:</p>
<ul>
<li><a href="https://marketplace.visualstudio.com/items?itemName=vadimcn.vscode-lldb">CodeLLDB</a></li>
<li><a href="https://marketplace.visualstudio.com/items?itemName=rust-lang.rust-analyzer">rust-analyzer</a></li>
</ul>
<h2 id="debugging-with-launchjson"><a class="header" href="#debugging-with-launchjson">Debugging with <code>launch.json</code></a></h2>
<p>Generally, you need to debug martin with specific arguments or a config file to fix issues or add features.</p>
<p>The most convenient way is to generate a launch.json and modify it.</p>
<h2 id="generate"><a class="header" href="#generate">Generate</a></h2>
<p>Press <code>F1</code> on your keyboard, and input “Generate Launch Configurations from Cargo.toml”. Execute it and save it to your <code>.vscode</code> directory.</p>
<h2 id="modify"><a class="header" href="#modify">Modify</a></h2>
<p>Let’s say you want to debugging Martin with this command:</p>
<pre><code class="language-shell">martin postgres://postgres:postgres@localhost:5411/db
</code></pre>
<p>You could find <code>Debug executable 'martin'</code> in your <code>launch.json</code>, like below:</p>
<pre><code class="language-json">{
    "type": "lldb",
    "request": "launch",
    "name": "Debug executable 'martin'",
    "cargo": {
        "args": [
            "build",
            "--bin=martin",
            "--package=martin"
        ],
        "filter": {
            "name": "martin",
            "kind": "bin"
        }
    },
    "args": [],
    "cwd": "${workspaceFolder}"
},
</code></pre>
<p>Just copy and paste after it, and modify your pasted like this:</p>
<pre><code class="language-javascript">{
    "type": "lldb",
    "request": "launch",
    "name": "my first debug", // name it any as you like
    "cargo": {
        "args": [
            "build",
            "--bin=martin",
            "--package=martin"
        ],
        "filter": {
            "name": "martin",
            "kind": "bin"
        }
    },
    "args": ["postgres://postgres:postgres@localhost:5411/db"], // add your arguments here
     "env": {
         "DEFAULT_SRID": 4490, // add your env here
     },
    "cwd": "${workspaceFolder}"
},
</code></pre>
<h3 id="add-a-breakpoint"><a class="header" href="#add-a-breakpoint">Add a breakpoint</a></h3>
<p>Go to any part you’re interested in of martin code and add a breakpoint.</p>
<p>We add a breakpoint here in the <a href="https://github.com/maplibre/martin/blob/e628c3973f193a432d3d1282c5893e2339e806b6/martin/src/bin/martin.rs#L10">start of martin</a>.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use clap::Parser;
use log::{error, info, log_enabled};
use martin::args::{Args, OsEnv};
use martin::srv::new_server;
use martin::{read_config, Config, MartinResult};

const VERSION: &amp;str = env!("CARGO_PKG_VERSION");

async fn start(args: Args) -&gt; MartinResult&lt;()&gt; {
    info!("Starting Martin v{VERSION}");
<span class="boring">}</span></code></pre></pre>
<h3 id="debugging"><a class="header" href="#debugging">Debugging</a></h3>
<p>Click <code>Run and Debug</code> on the left panel of <code>Visual Studio Code</code>. Choose <code>my first debug</code> and press <code>F5</code> on your keyboard.</p>
<p>Wait for the breakpoint to be hit.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="martin-as-a-library"><a class="header" href="#martin-as-a-library">Martin as a library</a></h1>
<p>Martin can be used as a standalone server, or as a library in your own Rust application. When used as a library, you can use the following features:</p>
<ul>
<li><strong>postgres</strong> - enable PostgreSQL/PostGIS tile sources</li>
<li><strong>pmtiles</strong> - enable PMTile tile sources</li>
<li><strong>mbtiles</strong> - enable MBTile tile sources</li>
<li><strong>fonts</strong> - enable font sources</li>
<li><strong>sprites</strong> - enable sprite sources</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
